<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><meta name="generator" content="Gatsby 2.15.29"/><title data-react-helmet="true">B-tree индексы в&lt;br/&gt; PostgreSQL</title><link as="script" rel="preload" href="/2023-09-16-dotnext-b-tree-indices-in-postgresql/webpack-runtime-b838201ac9a3bfd7e165.js"/><link as="script" rel="preload" href="/2023-09-16-dotnext-b-tree-indices-in-postgresql/commons-fd685cc757fe6153f6ab.js"/><link as="script" rel="preload" href="/2023-09-16-dotnext-b-tree-indices-in-postgresql/app-78bd9bdba74bae70269f.js"/><link as="script" rel="preload" href="/2023-09-16-dotnext-b-tree-indices-in-postgresql/component---gatsby-theme-mdx-deck-src-templates-deck-js-83081728262a35733deb.js"/><link as="fetch" rel="preload" href="/2023-09-16-dotnext-b-tree-indices-in-postgresql/page-data/print/page-data.json" crossorigin="anonymous"/></head><body><script>(function() { try {
        var mode = localStorage.getItem('theme-ui-color-mode');
        if (!mode) return
        document.body.classList.add('theme-ui-' + mode);
      } catch (e) {} })();</script><noscript id="gatsby-noscript">This app works best with JavaScript enabled.</noscript><div id="___gatsby"><div style="outline:none" tabindex="-1" role="group" id="gatsby-focus-wrapper"><style data-emotion-css="13j5fvw">body{margin:0;}</style><style data-emotion-css="bdfrlc">.css-bdfrlc{width:100vw;height:100vh;}.css-bdfrlc *{box-sizing:border-box;}</style><div class="css-bdfrlc"><div style="outline:none;height:100%" tabindex="-1" role="group"><style data-emotion-css="1qmwe25">.css-1qmwe25{box-sizing:border-box;width:100%;height:100vh;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;overflow:hidden;position:relative;color:var(--theme-ui-colors-text,#ffffff);background-color:var(--theme-ui-colors-background,rgb(0,0,0));font-family:system-ui,sans-serif;font-size:48px;}</style><div class="css-1qmwe25"><style data-emotion-css="m1f71q">.css-m1f71q{width:100%;height:100%;background-image:url(/2023-09-16-dotnext-b-tree-indices-in-postgresql/static/unsplash-book-ea1baf3819453cc2409fa77a135af19a.jpeg);background-size:cover;background-position:center;background-repeat:no-repeat;}</style><div alt="book" style="display:flex;align-items:center;justify-content:center;color:white;background-color:black" class="css-m1f71q"><style data-emotion-css="1oufjjy">.css-1oufjjy{font-family:inherit;line-height:1.125;font-weight:700;text-align:center;}</style><h1 class="css-1oufjjy">B-tree индексы в<br/> PostgreSQL</h1></div><div style="position:absolute;font-size:30px;right:10px;bottom:10px"></div></div><div class="css-1qmwe25"><style data-emotion-css="tz4rfl">.css-tz4rfl{width:100%;height:100%;background-image:url(/2023-09-16-dotnext-b-tree-indices-in-postgresql/static/sitnikov-b4f0151e3e4adfa690b795a1e4693ee9.jpg);background-size:cover;background-position:center;background-repeat:no-repeat;}</style><div style="display:block;align-items:center;justify-content:center;color:white;background-color:black;background-position:200px 0px;padding-left:100px;padding-top:200px" class="css-tz4rfl"><p class="css-0">Владимир Ситников</p><p class="css-0">Performance engineer<br/>
JMeter, pgjdbc committer</p><p class="css-0"><style data-emotion-css="2lflbl">.css-2lflbl{color:var(--theme-ui-colors-primary,rgb(173,219,103));}</style><a href="https://twitter.com/VladimirSitnikv" class="css-2lflbl">@VladimirSitnikv</a></p><a href="mailto:sitnikov.vladimir@gmail.com" class="css-2lflbl">sitnikov.vladimir@gmail.com</a></div><div style="position:absolute;font-size:30px;right:10px;bottom:10px"></div></div><div class="css-1qmwe25"><h1 class="css-1oufjjy">При чём тут PostgreSQL?</h1><div style="position:absolute;font-size:30px;right:10px;bottom:10px"></div></div><div class="css-1qmwe25"><h1 class="css-1oufjjy">Невозможно избежать<br/>базы данных</h1><div style="position:absolute;font-size:30px;right:10px;bottom:10px"></div></div><div class="css-1qmwe25"><h1 class="css-1oufjjy">PostgreSQL, MySQL, SQLite, ...</h1><div style="position:absolute;font-size:30px;right:10px;bottom:10px"></div></div><div class="css-1qmwe25"><style data-emotion-css="1djqpdg">.css-1djqpdg{font-family:inherit;line-height:1.125;font-weight:700;}</style><h2 class="css-1djqpdg">Что будет на докладе</h2><style data-emotion-css="1uk1gs8">.css-1uk1gs8{margin:0;}</style><ul class="css-1uk1gs8"><li style="visibility:visible" class="css-0"><span style="color:rgb(102,255,122)">Алгоритмы</span> работы <span style="color:rgb(102,255,122)">B-Tree</span> индексов</li><li style="visibility:visible" class="css-0">Применение <span style="color:rgb(102,255,122)">индексов</span> в запросах</li><li style="visibility:visible" class="css-0">Применение <span style="color:rgb(102,255,122)">многоколоночных</span> индексов</li></ul><div style="position:absolute;font-size:30px;right:10px;bottom:10px"></div></div><div class="css-1qmwe25"><div style="width:100vw;max-width:100%;height:100vh;display:flex;flex-direction:column;justify-content:center;align-items:center" class="cs-layout"><div style="overflow:auto;height:100%;width:100%"><div style="overflow:auto;height:100%;width:100%"><div class="cs-container" style="width:100%;height:100%;max-height:100%;position:relative"><style data-emotion-css="15hx6wk">.css-15hx6wk{color:#d6deeb;background-color:var(--theme-ui-colors-background,rgb(0,0,0));}.css-15hx6wk .token-changed{color:rgb(162,191,252);font-style:italic;}.css-15hx6wk .token-deleted{color:salmon;font-style:italic;}.css-15hx6wk .token-inserted,.css-15hx6wk .token-attr-name{color:rgb(173,219,103);font-style:italic;}.css-15hx6wk .token-comment{color:rgb(99,119,119);font-style:italic;}.css-15hx6wk .token-string,.css-15hx6wk .token-url{color:rgb(173,219,103);}.css-15hx6wk .token-variable{color:rgb(214,222,235);}.css-15hx6wk .token-number{color:rgb(102,255,122);}.css-15hx6wk .token-builtin,.css-15hx6wk .token-char,.css-15hx6wk .token-constant,.css-15hx6wk .token-function{color:rgb(130,170,255);}.css-15hx6wk .token-punctuation{color:rgb(199,146,234);}.css-15hx6wk .token-selector,.css-15hx6wk .token-doctype{color:rgb(199,146,234);font-style:italic;}.css-15hx6wk .token-class-name{color:rgb(255,203,139);}.css-15hx6wk .token-tag,.css-15hx6wk .token-operator,.css-15hx6wk .token-keyword{color:rgb(127,219,202);}.css-15hx6wk .token-boolean{color:rgb(255,88,116);}.css-15hx6wk .token-property{color:rgb(128,203,196);}.css-15hx6wk .token-namespace{color:rgb(178,204,214);}.css-15hx6wk .token-class-name,.css-15hx6wk .token-function,.css-15hx6wk .token-punctuation,.css-15hx6wk .token-operator,.css-15hx6wk .token-comment{color:var(--theme-ui-colors-text,#ffffff);}.css-15hx6wk .token-string{color:rgb(206,205,152);}.css-15hx6wk .token-keyword{color:rgb(102,255,122);}.css-15hx6wk .token-annotation{color:rgb(102,255,122);font-weight:700;}.css-15hx6wk .token-constant{color:rgb(102,255,122);}.css-15hx6wk .token-deleted-sign{color:salmon;}.css-15hx6wk .token-inserted{color:rgb(93,123,197);}.css-15hx6wk .token-inserted-sign{color:rgb(93,123,197);}</style><pre class="cs-content css-15hx6wk" style="margin:0;height:100%;overflow:hidden"><style data-emotion-css="7wj8j4">.css-7wj8j4{color:#d6deeb;background-color:var(--theme-ui-colors-background,rgb(0,0,0));font-family:"JetBrains Mono",Menlo;}</style><code class="cs-scaled-content css-7wj8j4" style="display:block;height:100%;transform:scale(1);transform-origin:center 0px"><div></div><div style="overflow:hidden;height:100px;opacity:1"><div style="display:inline-block" class="cs-line cs-line-0"><span class="token-keyword">public</span><span class="token-plain"> </span><span class="token-keyword">class</span><span class="token-plain"> </span><span class="token-class-name">User</span></div></div><div style="overflow:hidden;opacity:1"><div style="display:inline-block" class="cs-line cs-line-1"><span class="token-punctuation">{</span></div></div><div style="overflow:hidden;height:100px;opacity:1"><div style="display:inline-block" class="cs-line cs-line-2"><span class="token-plain">    </span><span class="token-keyword">public</span><span class="token-plain"> </span><span class="token-keyword">int</span><span class="token-plain"> UserId </span><span class="token-punctuation">{</span><span class="token-plain"> </span><span class="token-keyword">get</span><span class="token-punctuation">;</span><span class="token-plain"> </span><span class="token-keyword">set</span><span class="token-punctuation">;</span><span class="token-plain"> </span><span class="token-punctuation">}</span></div></div><div style="overflow:hidden;height:100px;opacity:1"><div style="display:inline-block" class="cs-line cs-line-3"><span class="token-plain">​</span></div></div><div style="overflow:hidden;height:100px;opacity:1"><div style="display:inline-block" class="cs-line cs-line-5"><span class="token-plain">    </span><span class="token-keyword">public</span><span class="token-plain"> </span><span class="token-keyword">string</span><span class="token-plain"> Username </span><span class="token-punctuation">{</span><span class="token-plain"> </span><span class="token-keyword">get</span><span class="token-punctuation">;</span><span class="token-plain"> </span><span class="token-keyword">set</span><span class="token-punctuation">;</span><span class="token-plain"> </span><span class="token-punctuation">}</span><span class="token-plain"> </span></div></div><div style="overflow:hidden;height:100px;opacity:1"><div style="display:inline-block" class="cs-line cs-line-6"><span class="token-plain">​</span></div></div><div style="overflow:hidden;opacity:1"><div style="display:inline-block" class="cs-line cs-line-7"><span class="token-plain">    </span><span class="token-keyword">public</span><span class="token-plain"> </span><span class="token-keyword">double</span><span class="token-plain"> PhoneNumber </span><span class="token-punctuation">{</span><span class="token-plain"> </span><span class="token-keyword">get</span><span class="token-punctuation">;</span><span class="token-plain"> </span><span class="token-keyword">set</span><span class="token-punctuation">;</span><span class="token-plain"> </span><span class="token-punctuation">}</span><span class="token-plain"> </span></div></div><div style="overflow:hidden;height:100px;opacity:1"><div style="display:inline-block" class="cs-line cs-line-8"><span class="token-punctuation">}</span></div></div><div></div></code></pre></div></div><div style="overflow:auto;height:100%;width:100%"><div class="cs-container" style="width:100%;height:100%;max-height:100%;position:relative"><pre class="cs-content css-15hx6wk" style="margin:0;height:100%;overflow:hidden"><code class="cs-scaled-content css-7wj8j4" style="display:block;height:100%;transform:scale(1);transform-origin:center 0px"><div></div><div style="overflow:hidden;height:100px;opacity:0.6"><div style="display:inline-block" class="cs-line cs-line-1"><span class="token-punctuation">{</span></div></div><div style="overflow:hidden;height:100px;opacity:0.6"><div style="display:inline-block" class="cs-line cs-line-7"><span class="token-plain">    </span><span class="token-keyword">public</span><span class="token-plain"> </span><span class="token-keyword">double</span><span class="token-plain"> PhoneNumber </span><span class="token-punctuation">{</span><span class="token-plain"> </span><span class="token-keyword">get</span><span class="token-punctuation">;</span><span class="token-plain"> </span><span class="token-keyword">set</span><span class="token-punctuation">;</span><span class="token-plain"> </span><span class="token-punctuation">}</span><span class="token-plain"> </span></div></div><div></div></code></pre></div></div></div></div><div style="position:absolute;font-size:30px;right:10px;bottom:10px"></div></div><div class="css-1qmwe25"><h1 class="css-1oufjjy">Зачем же нужны индексы?</h1><div style="position:absolute;font-size:30px;right:10px;bottom:10px"></div></div><div class="css-1qmwe25"><h2 class="css-1djqpdg">Индексы нужны для<br/> </h2><div style="position:absolute;font-size:30px;right:10px;bottom:10px"></div></div><div class="css-1qmwe25"><h2 class="css-1djqpdg">Индексы нужны для<br/><span style="color:rgb(102,255,122)">быстрой выборки</span></h2><div style="position:absolute;font-size:30px;right:10px;bottom:10px"></div></div><div class="css-1qmwe25"><h2 class="css-1djqpdg">Варианты использования индексов</h2><ul class="css-1uk1gs8"><li style="visibility:visible" class="css-0">поиск по ключу: <style data-emotion-css="6vhczm">.css-6vhczm{font-family:"JetBrains Mono",Menlo;}</style><code style="color:rgb(102,255,122)" class="css-6vhczm">where id = ?</code></li><li style="visibility:visible" class="css-0">поиск по составному ключу: <code style="color:rgb(102,255,122)" class="css-6vhczm">where order_id = ? and line_id = ?</code></li><li style="visibility:visible" class="css-0">поиск по диапазону: <code style="color:rgb(102,255,122)" class="css-6vhczm">where created_when &gt; ?</code></li><li style="visibility:visible" class="css-0">поиск по диапазону: <code style="color:rgb(102,255,122)" class="css-6vhczm">where created_when beetween ? and ?</code></li><li style="visibility:visible" class="css-0">top N: <code style="color:rgb(102,255,122)" class="css-6vhczm">order by created_when</code></li><li style="visibility:visible" class="css-0">обработка <code style="color:rgb(102,255,122)" class="css-6vhczm">foreign keys</code></li></ul><div style="position:absolute;font-size:30px;right:10px;bottom:10px"></div></div><div class="css-1qmwe25"><h3 class="css-1djqpdg">Примеры</h3><p class="css-0"><a href="https://use-the-index-luke.com/" class="css-2lflbl">https://use-the-index-luke.com/</a></p><div style="position:absolute;font-size:30px;right:10px;bottom:10px"></div></div><div class="css-1qmwe25"><h2 class="css-1djqpdg">По-хорошему, нужно понять цель:</h2><ul class="css-1uk1gs8"><li style="visibility:visible" class="css-0">оптимизируем чтение (DML страдает)</li><li style="visibility:visible" class="css-0">оптимизируем модификацию (SELECT страдает)</li><li style="visibility:visible" class="css-0">оптимизируем всё вместе (засучите рукава)</li></ul><div style="position:absolute;font-size:30px;right:10px;bottom:10px"></div></div><div class="css-1qmwe25"><h2 class="css-1djqpdg">Какой должен быть индекс?</h2><ul class="css-1uk1gs8"><li style="visibility:visible" class="css-0"><span style="color:rgb(102,255,122)">Просто</span> индекс. Какие вопросы?</li><li style="visibility:visible" class="css-0">Всегда <span style="color:rgb(102,255,122)">оптимальный</span></li></ul><div style="position:absolute;font-size:30px;right:10px;bottom:10px"></div></div><div class="css-1qmwe25"><h2 class="css-1djqpdg">Критерии оптимальности</h2><ul class="css-1uk1gs8"><li style="visibility:visible" class="css-0">Эффективная работа на <span style="color:rgb(102,255,122)">больших</span> данных</li><li style="visibility:visible" class="css-0">Эффективная работа на <span style="color:rgb(102,255,122)">маленьких</span> данных</li><li style="visibility:visible" class="css-0">Эффективный <span style="color:rgb(102,255,122)">многопользовательский</span> доступ</li></ul><div style="position:absolute;font-size:30px;right:10px;bottom:10px"></div></div><div class="css-1qmwe25"><h1 class="css-1oufjjy">Индекс может <span style="color:rgb(102,255,122)">не поместиться</span><br/>в ОЗУ</h1><div style="position:absolute;font-size:30px;right:10px;bottom:10px"></div></div><div class="css-1qmwe25"><h1 style="visibility:visible" class="css-1oufjjy">Сначала была страница</h1><div style="position:absolute;font-size:30px;right:10px;bottom:10px"></div></div><div class="css-1qmwe25"><h2 style="position:absolute;top:0.1em" class="css-1djqpdg"></h2><style data-emotion-css="wnzno2">.css-wnzno2{max-width:100%;height:auto;object-fit:cover;}</style><img src="/2023-09-16-dotnext-b-tree-indices-in-postgresql/static/btree-branch_links_02.drawio-6dfe620924969709214b09d7751e0230.svg" width="100%" class="css-wnzno2"/><h2 style="position:absolute;bottom:2em" class="css-1djqpdg"></h2><div style="position:absolute;font-size:30px;right:10px;bottom:10px"></div></div><div class="css-1qmwe25"><div style="width:100vw;max-width:100%;height:100vh;display:flex;flex-direction:column;justify-content:center;align-items:center" class="cs-layout"><div style="overflow:auto;height:100%;width:100%"><div style="overflow:auto;height:100%;width:100%"><div class="cs-container" style="width:100%;height:100%;max-height:100%;position:relative"><pre class="cs-content css-15hx6wk" style="margin:0;height:100%;overflow:hidden"><code class="cs-scaled-content css-7wj8j4" style="display:block;height:100%;transform:scale(1);transform-origin:center 0px"><div></div><div style="overflow:hidden;height:100px;opacity:1"><div style="display:inline-block" class="cs-line cs-line-0"><span class="token-keyword">create</span><span class="token-plain"> </span><span class="token-keyword">table</span><span class="token-plain"> users </span><span class="token-punctuation">(</span></div></div><div style="overflow:hidden;height:100px;opacity:1"><div style="display:inline-block" class="cs-line cs-line-1"><span class="token-plain">  id </span><span class="token-keyword">bigint</span><span class="token-plain"> </span><span class="token-keyword">primary</span><span class="token-plain"> </span><span class="token-keyword">key</span><span class="token-punctuation">,</span></div></div><div style="overflow:hidden;height:100px;opacity:1"><div style="display:inline-block" class="cs-line cs-line-2"><span class="token-plain">  name </span><span class="token-keyword">varchar</span><span class="token-punctuation">(</span><span class="token-number">200</span><span class="token-punctuation">)</span></div></div><div style="overflow:hidden;height:100px;opacity:1"><div style="display:inline-block" class="cs-line cs-line-3"><span class="token-punctuation">)</span><span class="token-punctuation">;</span></div></div><div style="overflow:hidden;height:0;opacity:0"><div style="display:inline-block" class="cs-line cs-line-4"><span class="token-plain">​</span></div></div><div style="overflow:hidden;height:0;opacity:0"><div style="display:inline-block" class="cs-line cs-line-7"><span class="token-plain">   </span><span class="token-keyword">from</span><span class="token-plain"> generate_series</span><span class="token-punctuation">(</span><span class="token-number">1</span><span class="token-punctuation">,</span><span class="token-plain"> </span><span class="token-number">1000000</span><span class="token-punctuation">)</span><span class="token-plain"> </span><span class="token-keyword">as</span><span class="token-plain"> g</span><span class="token-punctuation">(</span><span class="token-plain">x</span><span class="token-punctuation">)</span><span class="token-punctuation">;</span></div></div><div></div></code></pre></div></div><div style="overflow:auto;height:100%;width:100%"><div class="cs-container" style="width:100%;height:100%;max-height:100%;position:relative"><pre class="cs-content css-15hx6wk" style="margin:0;height:100%;overflow:hidden"><code class="cs-scaled-content css-7wj8j4" style="display:block;height:100%;transform:scale(1);transform-origin:center 0px"><div></div><div style="overflow:hidden"><div style="display:inline-block" class="cs-line cs-line-4"><span class="token-plain">​</span></div></div><div style="overflow:hidden;opacity:0.6"><div style="display:inline-block" class="cs-line cs-line-7"><span class="token-plain">   </span><span class="token-keyword">from</span><span class="token-plain"> generate_series</span><span class="token-punctuation">(</span><span class="token-number">1</span><span class="token-punctuation">,</span><span class="token-plain"> </span><span class="token-number">1000000</span><span class="token-punctuation">)</span><span class="token-plain"> </span><span class="token-keyword">as</span><span class="token-plain"> g</span><span class="token-punctuation">(</span><span class="token-plain">x</span><span class="token-punctuation">)</span><span class="token-punctuation">;</span></div></div><div></div></code></pre></div></div><div style="overflow:auto;height:100%;width:100%"><div class="cs-container" style="width:100%;height:100%;max-height:100%;position:relative"><pre class="cs-content css-15hx6wk" style="margin:0;height:100%;overflow:hidden"><code class="cs-scaled-content css-7wj8j4" style="display:block;height:100%;transform:scale(1);transform-origin:center 0px"><div></div><div style="overflow:hidden"><div style="display:inline-block" class="cs-line cs-line-4"><span class="token-plain">​</span></div></div><div style="overflow:hidden;opacity:0.6"><div style="display:inline-block" class="cs-line cs-line-7"><span class="token-plain">   </span><span class="token-keyword">from</span><span class="token-plain"> generate_series</span><span class="token-punctuation">(</span><span class="token-number">1</span><span class="token-punctuation">,</span><span class="token-plain"> </span><span class="token-number">1000000</span><span class="token-punctuation">)</span><span class="token-plain"> </span><span class="token-keyword">as</span><span class="token-plain"> g</span><span class="token-punctuation">(</span><span class="token-plain">x</span><span class="token-punctuation">)</span><span class="token-punctuation">;</span></div></div><div></div></code></pre></div></div><div style="overflow:auto;height:100%;width:100%"><div class="cs-container" style="width:100%;height:100%;max-height:100%;position:relative"><pre class="cs-content css-15hx6wk" style="margin:0;height:100%;overflow:hidden"><code class="cs-scaled-content css-7wj8j4" style="display:block;height:100%;transform:scale(1);transform-origin:center 0px"><div></div><div style="overflow:hidden;height:100px;opacity:1"><div style="display:inline-block" class="cs-line cs-line-4"><span class="token-plain">​</span></div></div><div style="overflow:hidden;height:100px;opacity:0.6"><div style="display:inline-block" class="cs-line cs-line-7"><span class="token-plain">   </span><span class="token-keyword">from</span><span class="token-plain"> generate_series</span><span class="token-punctuation">(</span><span class="token-number">1</span><span class="token-punctuation">,</span><span class="token-plain"> </span><span class="token-number">1000000</span><span class="token-punctuation">)</span><span class="token-plain"> </span><span class="token-keyword">as</span><span class="token-plain"> g</span><span class="token-punctuation">(</span><span class="token-plain">x</span><span class="token-punctuation">)</span><span class="token-punctuation">;</span></div></div><div></div></code></pre></div></div></div></div><div style="position:absolute;font-size:30px;right:10px;bottom:10px"></div></div><div class="css-1qmwe25"><div style="width:100vw;max-width:100%;height:100vh;display:flex;flex-direction:column;justify-content:center;align-items:center" class="cs-layout"><div style="overflow:auto;height:100%;width:100%"><div style="overflow:auto;height:100%;width:100%"><div class="cs-container" style="width:100%;height:100%;max-height:100%;position:relative"><pre class="cs-content css-15hx6wk" style="margin:0;height:100%;overflow:hidden"><code class="cs-scaled-content css-7wj8j4" style="display:block;height:100%;transform:scale(1);transform-origin:center 0px"><div></div><div style="overflow:hidden;height:100px;opacity:1"><div style="display:inline-block" class="cs-line cs-line-0"><span class="token-keyword">explain</span><span class="token-plain"> </span><span class="token-keyword">analyze</span></div></div><div style="overflow:hidden;height:100px;opacity:1"><div style="display:inline-block" class="cs-line cs-line-1"><span class="token-plain">  </span><span class="token-keyword">select</span><span class="token-plain"> id</span><span class="token-punctuation">,</span><span class="token-plain"> name</span></div></div><div style="overflow:hidden;height:100px;opacity:1"><div style="display:inline-block" class="cs-line cs-line-2"><span class="token-plain">    </span><span class="token-keyword">from</span><span class="token-plain"> users</span></div></div><div style="overflow:hidden;height:100px;opacity:1"><div style="display:inline-block" class="cs-line cs-line-3"><span class="token-plain">   </span><span class="token-keyword">where</span><span class="token-plain"> id </span><span class="token-operator">=</span><span class="token-plain"> </span><span class="token-number">1</span><span class="token-punctuation">;</span></div></div><div style="overflow:hidden;height:0;opacity:0"><div style="display:inline-block" class="cs-line cs-line-4"><span class="token-plain">​</span></div></div><div style="overflow:hidden;height:0;opacity:0"><div style="display:inline-block" class="cs-line cs-line-5"><span class="token-keyword">Index</span><span class="token-plain"> Scan </span><span class="token-keyword">using</span><span class="token-plain"> users_pkey </span><span class="token-keyword">on</span><span class="token-plain"> users  </span><span class="token-punctuation">(</span><span class="token-plain">cost</span><span class="token-operator">=</span><span class="token-number">0.42</span><span class="token-punctuation">.</span><span class="token-number">.8</span><span class="token-number">.44</span><span class="token-plain"> </span><span class="token-keyword">rows</span><span class="token-operator">=</span><span class="token-number">1</span><span class="token-plain"> width</span><span class="token-operator">=</span><span class="token-number">18</span><span class="token-punctuation">)</span></div></div><div></div></code></pre></div></div><div style="overflow:auto;height:100%;width:100%"><div class="cs-container" style="width:100%;height:100%;max-height:100%;position:relative"><pre class="cs-content css-15hx6wk" style="margin:0;height:100%;overflow:hidden"><code class="cs-scaled-content css-7wj8j4" style="display:block;height:100%;transform:scale(1);transform-origin:center 0px"><div></div><div style="overflow:hidden"><div style="display:inline-block" class="cs-line cs-line-4"><span class="token-plain">​</span></div></div><div style="overflow:hidden;opacity:0.6"><div style="display:inline-block" class="cs-line cs-line-5"><span class="token-keyword">Index</span><span class="token-plain"> Scan </span><span class="token-keyword">using</span><span class="token-plain"> users_pkey </span><span class="token-keyword">on</span><span class="token-plain"> users  </span><span class="token-punctuation">(</span><span class="token-plain">cost</span><span class="token-operator">=</span><span class="token-number">0.42</span><span class="token-punctuation">.</span><span class="token-number">.8</span><span class="token-number">.44</span><span class="token-plain"> </span><span class="token-keyword">rows</span><span class="token-operator">=</span><span class="token-number">1</span><span class="token-plain"> width</span><span class="token-operator">=</span><span class="token-number">18</span><span class="token-punctuation">)</span></div></div><div></div></code></pre><style data-emotion-css="1bb7pgx">.css-1bb7pgx{position:absolute;top:0;width:100%;margin:0;padding:1em 0;text-align:center;background:rgba(1,22,39,0.8);color:#d6deeb;text:#ffffff;background-color:var(--theme-ui-colors-background,rgb(0,0,0));}</style><h4 class="cs-title css-1bb7pgx" style="opacity:0"><span style="opacity:1"></span></h4></div></div><div style="overflow:auto;height:100%;width:100%"><div class="cs-container" style="width:100%;height:100%;max-height:100%;position:relative"><pre class="cs-content css-15hx6wk" style="margin:0;height:100%;overflow:hidden"><code class="cs-scaled-content css-7wj8j4" style="display:block;height:100%;transform:scale(1);transform-origin:center 0px"><div></div><div style="overflow:hidden;opacity:1"><div style="display:inline-block" class="cs-line cs-line-4"><span class="token-plain">​</span></div></div><div style="overflow:hidden;opacity:0.6"><div style="display:inline-block" class="cs-line cs-line-5"><span class="token-keyword">Index</span><span class="token-plain"> Scan </span><span class="token-keyword">using</span><span class="token-plain"> users_pkey </span><span class="token-keyword">on</span><span class="token-plain"> users  </span><span class="token-punctuation">(</span><span class="token-plain">cost</span><span class="token-operator">=</span><span class="token-number">0.42</span><span class="token-punctuation">.</span><span class="token-number">.8</span><span class="token-number">.44</span><span class="token-plain"> </span><span class="token-keyword">rows</span><span class="token-operator">=</span><span class="token-number">1</span><span class="token-plain"> width</span><span class="token-operator">=</span><span class="token-number">18</span><span class="token-punctuation">)</span></div></div><div></div></code></pre><h4 class="cs-title css-1bb7pgx"><span style="opacity:1">фактическая длительность запроса</span></h4></div></div><div style="overflow:auto;height:100%;width:100%"><div class="cs-container" style="width:100%;height:100%;max-height:100%;position:relative"><pre class="cs-content css-15hx6wk" style="margin:0;height:100%;overflow:hidden"><code class="cs-scaled-content css-7wj8j4" style="display:block;height:100%;transform:scale(1);transform-origin:center 0px"><div></div><div style="overflow:hidden;opacity:0.6"><div style="display:inline-block" class="cs-line cs-line-4"><span class="token-plain">​</span></div></div><div style="overflow:hidden;opacity:0.6"><div style="display:inline-block" class="cs-line cs-line-5"><span class="token-keyword">Index</span><span class="token-plain"> Scan </span><span class="token-keyword">using</span><span class="token-plain"> users_pkey </span><span class="token-keyword">on</span><span class="token-plain"> users  </span><span class="token-punctuation">(</span><span class="token-plain">cost</span><span class="token-operator">=</span><span class="token-number">0.42</span><span class="token-punctuation">.</span><span class="token-number">.8</span><span class="token-number">.44</span><span class="token-plain"> </span><span class="token-keyword">rows</span><span class="token-operator">=</span><span class="token-number">1</span><span class="token-plain"> width</span><span class="token-operator">=</span><span class="token-number">18</span><span class="token-punctuation">)</span></div></div><div></div></code></pre><h4 class="cs-title css-1bb7pgx" style="opacity:1"><span style="opacity:1">построение плана выполнения</span></h4></div></div><div style="overflow:auto;height:100%;width:100%"><div class="cs-container" style="width:100%;height:100%;max-height:100%;position:relative"><pre class="cs-content css-15hx6wk" style="margin:0;height:100%;overflow:hidden"><code class="cs-scaled-content css-7wj8j4" style="display:block;height:100%;transform:scale(1);transform-origin:center 0px"><div></div><div style="overflow:hidden"><div style="display:inline-block" class="cs-line cs-line-4"><span class="token-plain">​</span></div></div><div style="overflow:hidden;opacity:1"><div style="display:inline-block" class="cs-line cs-line-5"><span class="token-keyword">Index</span><span class="token-plain"> Scan </span><span class="token-keyword">using</span><span class="token-plain"> users_pkey </span><span class="token-keyword">on</span><span class="token-plain"> users  </span><span class="token-punctuation">(</span><span class="token-plain">cost</span><span class="token-operator">=</span><span class="token-number">0.42</span><span class="token-punctuation">.</span><span class="token-number">.8</span><span class="token-number">.44</span><span class="token-plain"> </span><span class="token-keyword">rows</span><span class="token-operator">=</span><span class="token-number">1</span><span class="token-plain"> width</span><span class="token-operator">=</span><span class="token-number">18</span><span class="token-punctuation">)</span></div></div><div></div></code></pre><h4 class="cs-title css-1bb7pgx" style="opacity:0"><span style="opacity:1"></span></h4></div></div><div style="overflow:auto;height:100%;width:100%"><div class="cs-container" style="width:100%;height:100%;max-height:100%;position:relative"><pre class="cs-content css-15hx6wk" style="margin:0;height:100%;overflow:hidden"><code class="cs-scaled-content css-7wj8j4" style="display:block;height:100%;transform:scale(1);transform-origin:center 0px"><div></div><div style="overflow:hidden;height:100px;opacity:1"><div style="display:inline-block" class="cs-line cs-line-4"><span class="token-plain">​</span></div></div><div style="overflow:hidden;height:100px;opacity:0.6"><div style="display:inline-block" class="cs-line cs-line-5"><span class="token-keyword">Index</span><span class="token-plain"> Scan </span><span class="token-keyword">using</span><span class="token-plain"> users_pkey </span><span class="token-keyword">on</span><span class="token-plain"> users  </span><span class="token-punctuation">(</span><span class="token-plain">cost</span><span class="token-operator">=</span><span class="token-number">0.42</span><span class="token-punctuation">.</span><span class="token-number">.8</span><span class="token-number">.44</span><span class="token-plain"> </span><span class="token-keyword">rows</span><span class="token-operator">=</span><span class="token-number">1</span><span class="token-plain"> width</span><span class="token-operator">=</span><span class="token-number">18</span><span class="token-punctuation">)</span></div></div><div></div></code></pre><h4 class="cs-title css-1bb7pgx" style="opacity:1"><span style="opacity:1">Откуда взялось name в результатах?</span></h4></div></div></div></div><div style="position:absolute;font-size:30px;right:10px;bottom:10px"></div></div><div class="css-1qmwe25"><img src="/2023-09-16-dotnext-b-tree-indices-in-postgresql/static/btree-index_table01.drawio-4fa410fe46973e4d65ef4f46d92bb05d.svg" width="100%" class="css-wnzno2"/><div style="position:absolute;font-size:30px;right:10px;bottom:10px"></div></div><div class="css-1qmwe25"><div style="text-align:left;font-size:60px" class="css-0"><ul class="css-1uk1gs8"><li class="css-0">Индекс отсортирован</li></ul><ul class="css-1uk1gs8"><li style="visibility:visible" class="css-0">На каждом уровне страницы связаны в список</li><li style="visibility:visible" class="css-0">Листья ссылаются на таблицу</li><li style="visibility:visible" class="css-0">В PostgreSQL таблица не сортирована</li></ul></div><div style="position:absolute;font-size:30px;right:10px;bottom:10px"></div></div><div class="css-1qmwe25"><h2 class="css-1djqpdg">Сколько длится чтение из памяти?</h2><div style="position:absolute;font-size:30px;right:10px;bottom:10px"></div></div><div class="css-1qmwe25"><style data-emotion-css="1ltu1y7">.css-1ltu1y7{width:100%;height:100%;background-image:url(/2023-09-16-dotnext-b-tree-indices-in-postgresql/static/maxresdefault-bZzeh4iBN-transformed-2b60c01c31fec5ec4209873fb663c9cf.jpeg);background-size:cover;background-position:center;background-repeat:no-repeat;}</style><div class="css-1ltu1y7"></div><div style="position:absolute;font-size:30px;right:10px;bottom:10px"></div></div><div class="css-1qmwe25"><h1 class="css-1oufjjy">Каждый программист должен знать<br/> эти числа</h1><p class="css-0"><a href="https://gist.github.com/hellerbarde/2843375" class="css-2lflbl">https://gist.github.com/hellerbarde/2843375</a></p><div style="position:absolute;font-size:30px;right:10px;bottom:10px"></div></div><div class="css-1qmwe25"><div style="width:100vw;max-width:100%;height:100vh;display:flex;flex-direction:column;justify-content:center;align-items:center" class="cs-layout"><div style="overflow:auto;height:100%;width:100%"><div style="overflow:auto;height:100%;width:100%"><div class="cs-container" style="width:100%;height:100%;max-height:100%;position:relative"><pre class="cs-content css-15hx6wk" style="margin:0;height:100%;overflow:hidden"><code class="cs-scaled-content css-7wj8j4" style="display:block;height:100%;transform:scale(1);transform-origin:center 0px"><div></div><div style="overflow:hidden;height:100px;opacity:1"><div style="display:inline-block" class="cs-line cs-line-0"><span class="token-plain">L1 cache reference ......................... 0.5 ns</span></div></div><div style="overflow:hidden;opacity:1"><div style="display:inline-block" class="cs-line cs-line-1"><span class="token-plain">Branch mispredict ............................ 5 ns</span></div></div><div style="overflow:hidden;height:100px;opacity:1"><div style="display:inline-block" class="cs-line cs-line-2"><span class="token-plain">L2 cache reference ........................... 7 ns</span></div></div><div style="overflow:hidden;height:100px;opacity:1"><div style="display:inline-block" class="cs-line cs-line-3"><span class="token-plain">Mutex lock/unlock ........................... 25 ns</span></div></div><div style="overflow:hidden;opacity:1"><div style="display:inline-block" class="cs-line cs-line-4"><span class="token-plain">Main memory reference ...................... 100 ns             </span></div></div><div style="overflow:hidden;height:100px;opacity:1"><div style="display:inline-block" class="cs-line cs-line-5"><span class="token-plain">Compress 1K bytes with Zippy ............. 3,000 ns  =   3 µs</span></div></div><div style="overflow:hidden;height:100px;opacity:1"><div style="display:inline-block" class="cs-line cs-line-6"><span class="token-plain">Send 2K bytes over 1 Gbps network ....... 20,000 ns  =  20 µs</span></div></div><div style="overflow:hidden;height:100px;opacity:1"><div style="display:inline-block" class="cs-line cs-line-7"><span class="token-plain">SSD random read ........................ 150,000 ns  = 150 µs</span></div></div><div style="overflow:hidden;height:100px;opacity:1"><div style="display:inline-block" class="cs-line cs-line-8"><span class="token-plain">Read 1 MB sequentially from memory ..... 250,000 ns  = 250 µs</span></div></div><div style="overflow:hidden;height:100px;opacity:1"><div style="display:inline-block" class="cs-line cs-line-9"><span class="token-plain">Round trip within same datacenter ...... 500,000 ns  = 0.5 ms</span></div></div><div style="overflow:hidden;height:100px;opacity:1"><div style="display:inline-block" class="cs-line cs-line-10"><span class="token-plain">Read 1 MB sequentially from SSD ...... 1,000,000 ns  =   1 ms</span></div></div><div style="overflow:hidden;height:100px;opacity:1"><div style="display:inline-block" class="cs-line cs-line-11"><span class="token-plain">Disk seek ........................... 10,000,000 ns  =  10 ms</span></div></div><div style="overflow:hidden;height:100px;opacity:1"><div style="display:inline-block" class="cs-line cs-line-12"><span class="token-plain">Read 1 MB sequentially from disk .... 20,000,000 ns  =  20 ms</span></div></div><div style="overflow:hidden;height:100px;opacity:1"><div style="display:inline-block" class="cs-line cs-line-13"><span class="token-plain">Send packet CA-&gt;Netherlands-&gt;CA .... 150,000,000 ns  = 150 ms</span></div></div><div></div></code></pre></div></div><div style="overflow:auto;height:100%;width:100%"><div class="cs-container" style="width:100%;height:100%;max-height:100%;position:relative"><pre class="cs-content css-15hx6wk" style="margin:0;height:100%;overflow:hidden"><code class="cs-scaled-content css-7wj8j4" style="display:block;height:100%;transform:scale(1);transform-origin:center 0px"><div></div><div style="overflow:hidden;opacity:0.6"><div style="display:inline-block" class="cs-line cs-line-1"><span class="token-plain">Branch mispredict ............................ 5 ns</span></div></div><div style="overflow:hidden;opacity:0.6"><div style="display:inline-block" class="cs-line cs-line-4"><span class="token-plain">Main memory reference ...................... 100 ns             </span></div></div><div></div></code></pre></div></div><div style="overflow:auto;height:100%;width:100%"><div class="cs-container" style="width:100%;height:100%;max-height:100%;position:relative"><pre class="cs-content css-15hx6wk" style="margin:0;height:100%;overflow:hidden"><code class="cs-scaled-content css-7wj8j4" style="display:block;height:100%;transform:scale(1);transform-origin:center 0px"><div></div><div style="overflow:hidden;opacity:0.6"><div style="display:inline-block" class="cs-line cs-line-1"><span class="token-plain">Branch mispredict ............................ 5 ns</span></div></div><div style="overflow:hidden;opacity:0.6"><div style="display:inline-block" class="cs-line cs-line-4"><span class="token-plain">Main memory reference ...................... 100 ns             </span></div></div><div></div></code></pre></div></div><div style="overflow:auto;height:100%;width:100%"><div class="cs-container" style="width:100%;height:100%;max-height:100%;position:relative"><pre class="cs-content css-15hx6wk" style="margin:0;height:100%;overflow:hidden"><code class="cs-scaled-content css-7wj8j4" style="display:block;height:100%;transform:scale(1);transform-origin:center 0px"><div></div><div style="overflow:hidden;height:100px;opacity:1"><div style="display:inline-block" class="cs-line cs-line-1"><span class="token-plain">Branch mispredict ............................ 5 ns</span></div></div><div style="overflow:hidden;height:100px;opacity:1"><div style="display:inline-block" class="cs-line cs-line-4"><span class="token-plain">Main memory reference ...................... 100 ns             </span></div></div><div></div></code></pre></div></div></div></div><div style="position:absolute;font-size:30px;right:10px;bottom:10px"></div></div><div class="css-1qmwe25"><div style="text-align:left;font-size:60px" class="css-0"><ul class="css-1uk1gs8"><li class="css-0">Диск намного медленнее памяти</li></ul><ul class="css-1uk1gs8"><li style="visibility:visible" class="css-0">Скорость выборки определяется количеством<br/> случайных чтений</li></ul></div><div style="position:absolute;font-size:30px;right:10px;bottom:10px"></div></div><div class="css-1qmwe25"><div style="width:100vw;max-width:100%;height:100vh;display:flex;flex-direction:column;justify-content:center;align-items:center" class="cs-layout"><div style="overflow:auto;height:100%;width:100%"><div style="overflow:auto;height:100%;width:100%"><div class="cs-container" style="width:100%;height:100%;max-height:100%;position:relative"><pre class="cs-content css-15hx6wk" style="margin:0;height:100%;overflow:hidden"><code class="cs-scaled-content css-7wj8j4" style="display:block;height:100%;transform:scale(1);transform-origin:center 0px"><div></div><div style="overflow:hidden;height:100px;opacity:1"><div style="display:inline-block" class="cs-line cs-line-0"><span class="token-keyword">explain</span></div></div><div style="overflow:hidden;height:100px;opacity:1"><div style="display:inline-block" class="cs-line cs-line-2"><span class="token-plain">  </span><span class="token-keyword">analyze</span></div></div><div style="overflow:hidden;height:100px;opacity:1"><div style="display:inline-block" class="cs-line cs-line-3"><span class="token-plain">  </span><span class="token-keyword">select</span><span class="token-plain"> id</span><span class="token-punctuation">,</span><span class="token-plain"> name</span></div></div><div style="overflow:hidden;height:100px;opacity:1"><div style="display:inline-block" class="cs-line cs-line-4"><span class="token-plain">    </span><span class="token-keyword">from</span><span class="token-plain"> users</span></div></div><div style="overflow:hidden;height:100px;opacity:1"><div style="display:inline-block" class="cs-line cs-line-5"><span class="token-plain">   </span><span class="token-keyword">where</span><span class="token-plain"> name </span><span class="token-operator">=</span><span class="token-plain"> </span><span class="token-string">&#x27;test1&#x27;</span><span class="token-punctuation">;</span></div></div><div style="overflow:hidden;opacity:1"><div style="display:inline-block" class="cs-line cs-line-6"><span class="token-plain">​</span></div></div><div style="overflow:hidden;opacity:1"><div style="display:inline-block" class="cs-line cs-line-7"><span class="token-plain">Seq Scan </span><span class="token-keyword">on</span><span class="token-plain"> users </span><span class="token-punctuation">(</span><span class="token-plain">actual </span><span class="token-keyword">time</span><span class="token-operator">=</span><span class="token-number">0.016</span><span class="token-punctuation">.</span><span class="token-number">.63</span><span class="token-number">.787</span><span class="token-plain"> </span><span class="token-keyword">rows</span><span class="token-operator">=</span><span class="token-number">1</span><span class="token-plain"> loops</span><span class="token-operator">=</span><span class="token-number">1</span><span class="token-punctuation">)</span></div></div><div style="overflow:hidden;height:100px;opacity:1"><div style="display:inline-block" class="cs-line cs-line-8"><span class="token-plain">  Filter: </span><span class="token-punctuation">(</span><span class="token-punctuation">(</span><span class="token-plain">name</span><span class="token-punctuation">)</span><span class="token-plain">::</span><span class="token-keyword">text</span><span class="token-plain"> </span><span class="token-operator">=</span><span class="token-plain"> </span><span class="token-string">&#x27;test1&#x27;</span><span class="token-plain">::</span><span class="token-keyword">text</span><span class="token-punctuation">)</span></div></div><div style="overflow:hidden;height:100px;opacity:1"><div style="display:inline-block" class="cs-line cs-line-9"><span class="token-plain">  </span><span class="token-keyword">Rows</span><span class="token-plain"> Removed </span><span class="token-keyword">by</span><span class="token-plain"> Filter: </span><span class="token-number">999999</span></div></div><div style="overflow:hidden;height:100px;opacity:1"><div style="display:inline-block" class="cs-line cs-line-11"><span class="token-plain">Execution </span><span class="token-keyword">Time</span><span class="token-plain">: </span><span class="token-number">60.402</span><span class="token-plain"> ms</span></div></div><div></div></code></pre></div></div><div style="overflow:auto;height:100%;width:100%"><div class="cs-container" style="width:100%;height:100%;max-height:100%;position:relative"><pre class="cs-content css-15hx6wk" style="margin:0;height:100%;overflow:hidden"><code class="cs-scaled-content css-7wj8j4" style="display:block;height:100%;transform:scale(1);transform-origin:center 0px"><div></div><div style="overflow:hidden;opacity:0.6"><div style="display:inline-block" class="cs-line cs-line-6"><span class="token-plain">​</span></div></div><div style="overflow:hidden;opacity:0.6"><div style="display:inline-block" class="cs-line cs-line-7"><span class="token-plain">Seq Scan </span><span class="token-keyword">on</span><span class="token-plain"> users </span><span class="token-punctuation">(</span><span class="token-plain">actual </span><span class="token-keyword">time</span><span class="token-operator">=</span><span class="token-number">0.016</span><span class="token-punctuation">.</span><span class="token-number">.63</span><span class="token-number">.787</span><span class="token-plain"> </span><span class="token-keyword">rows</span><span class="token-operator">=</span><span class="token-number">1</span><span class="token-plain"> loops</span><span class="token-operator">=</span><span class="token-number">1</span><span class="token-punctuation">)</span></div></div><div></div></code></pre></div></div><div style="overflow:auto;height:100%;width:100%"><div class="cs-container" style="width:100%;height:100%;max-height:100%;position:relative"><pre class="cs-content css-15hx6wk" style="margin:0;height:100%;overflow:hidden"><code class="cs-scaled-content css-7wj8j4" style="display:block;height:100%;transform:scale(1);transform-origin:center 0px"><div></div><div style="overflow:hidden;opacity:0.6"><div style="display:inline-block" class="cs-line cs-line-6"><span class="token-plain">​</span></div></div><div style="overflow:hidden;height:100px;opacity:0.6"><div style="display:inline-block" class="cs-line cs-line-7"><span class="token-plain">Seq Scan </span><span class="token-keyword">on</span><span class="token-plain"> users </span><span class="token-punctuation">(</span><span class="token-plain">actual </span><span class="token-keyword">time</span><span class="token-operator">=</span><span class="token-number">0.016</span><span class="token-punctuation">.</span><span class="token-number">.63</span><span class="token-number">.787</span><span class="token-plain"> </span><span class="token-keyword">rows</span><span class="token-operator">=</span><span class="token-number">1</span><span class="token-plain"> loops</span><span class="token-operator">=</span><span class="token-number">1</span><span class="token-punctuation">)</span></div></div><div style="overflow:hidden;height:0;opacity:0"><div style="display:inline-block" class="cs-line cs-line-13"><span class="token-keyword">Index</span><span class="token-plain"> Scan </span><span class="token-keyword">using</span><span class="token-plain"> name__users </span><span class="token-keyword">on</span><span class="token-plain"> users </span><span class="token-punctuation">(</span><span class="token-plain">actual </span><span class="token-keyword">time</span><span class="token-operator">=</span><span class="token-number">0.047</span><span class="token-punctuation">.</span><span class="token-number">.0</span><span class="token-number">.048</span><span class="token-plain"> </span><span class="token-keyword">rows</span><span class="token-operator">=</span><span class="token-number">1</span><span class="token-plain"> loops</span><span class="token-operator">=</span><span class="token-number">1</span><span class="token-punctuation">)</span></div></div><div></div></code></pre></div></div><div style="overflow:auto;height:100%;width:100%"><div class="cs-container" style="width:100%;height:100%;max-height:100%;position:relative"><pre class="cs-content css-15hx6wk" style="margin:0;height:100%;overflow:hidden"><code class="cs-scaled-content css-7wj8j4" style="display:block;height:100%;transform:scale(1);transform-origin:center 0px"><div></div><div style="overflow:hidden;height:100px;opacity:0.6"><div style="display:inline-block" class="cs-line cs-line-6"><span class="token-plain">​</span></div></div><div style="overflow:hidden;height:100px;opacity:0.6"><div style="display:inline-block" class="cs-line cs-line-13"><span class="token-keyword">Index</span><span class="token-plain"> Scan </span><span class="token-keyword">using</span><span class="token-plain"> name__users </span><span class="token-keyword">on</span><span class="token-plain"> users </span><span class="token-punctuation">(</span><span class="token-plain">actual </span><span class="token-keyword">time</span><span class="token-operator">=</span><span class="token-number">0.047</span><span class="token-punctuation">.</span><span class="token-number">.0</span><span class="token-number">.048</span><span class="token-plain"> </span><span class="token-keyword">rows</span><span class="token-operator">=</span><span class="token-number">1</span><span class="token-plain"> loops</span><span class="token-operator">=</span><span class="token-number">1</span><span class="token-punctuation">)</span></div></div><div></div></code></pre></div></div></div></div><div style="position:absolute;font-size:30px;right:10px;bottom:10px"></div></div><div class="css-1qmwe25"><div style="text-align:left;font-size:60px" class="css-0"><ul class="css-1uk1gs8"><li class="css-0">Типичный размер страницы: 8 килобайт</li></ul><ul class="css-1uk1gs8"><li style="visibility:visible" class="css-0">На страницу помещается ~100 записей</li><li style="visibility:visible" class="css-0">Высота индекса это <code class="css-6vhczm">4.5=Log<sub>100</sub>(1&#x27;000&#x27;000&#x27;000)</code></li></ul></div><div style="position:absolute;font-size:30px;right:10px;bottom:10px"></div></div><div class="css-1qmwe25"><h1 class="css-1oufjjy">Поиск по диапазону</h1><div style="position:absolute;font-size:30px;right:10px;bottom:10px"></div></div><div class="css-1qmwe25"><div style="width:100vw;max-width:100%;height:100vh;display:flex;flex-direction:column;justify-content:center;align-items:center" class="cs-layout"><div style="overflow:auto;height:100%;width:100%"><div style="overflow:auto;height:100%;width:100%"><div class="cs-container" style="width:100%;height:100%;max-height:100%;position:relative"><pre class="cs-content css-15hx6wk" style="margin:0;height:100%;overflow:hidden"><code class="cs-scaled-content css-7wj8j4" style="display:block;height:100%;transform:scale(1);transform-origin:center 0px"><div></div><div style="overflow:hidden;height:100px;opacity:1"><div style="display:inline-block" class="cs-line cs-line-0"><span class="token-keyword">explain</span><span class="token-plain"> </span><span class="token-punctuation">(</span><span class="token-keyword">analyze</span><span class="token-punctuation">,</span><span class="token-plain"> costs </span><span class="token-keyword">off</span><span class="token-punctuation">,</span><span class="token-plain"> buffers</span><span class="token-punctuation">)</span></div></div><div style="overflow:hidden;height:100px;opacity:1"><div style="display:inline-block" class="cs-line cs-line-1"><span class="token-plain">  </span><span class="token-keyword">select</span><span class="token-plain"> id</span><span class="token-punctuation">,</span><span class="token-plain"> name</span></div></div><div style="overflow:hidden;height:100px;opacity:1"><div style="display:inline-block" class="cs-line cs-line-2"><span class="token-plain">    </span><span class="token-keyword">from</span><span class="token-plain"> users</span></div></div><div style="overflow:hidden;height:100px;opacity:1"><div style="display:inline-block" class="cs-line cs-line-3"><span class="token-plain">    </span><span class="token-keyword">where</span><span class="token-plain"> id </span><span class="token-operator">&gt;=</span><span class="token-plain"> </span><span class="token-number">5</span><span class="token-plain"> </span><span class="token-operator">and</span><span class="token-plain"> id </span><span class="token-operator">&lt;=</span><span class="token-plain"> </span><span class="token-number">8</span><span class="token-punctuation">;</span></div></div><div style="overflow:hidden;height:0;opacity:0"><div style="display:inline-block" class="cs-line cs-line-4"><span class="token-plain">​</span></div></div><div style="overflow:hidden;height:0;opacity:0"><div style="display:inline-block" class="cs-line cs-line-5"><span class="token-keyword">Index</span><span class="token-plain"> Scan </span><span class="token-keyword">using</span><span class="token-plain"> users_pkey </span><span class="token-keyword">on</span><span class="token-plain"> users </span><span class="token-punctuation">(</span><span class="token-plain">actual </span><span class="token-keyword">time</span><span class="token-operator">=</span><span class="token-number">0.036</span><span class="token-punctuation">.</span><span class="token-number">.0</span><span class="token-number">.041</span><span class="token-plain"> </span><span class="token-keyword">rows</span><span class="token-operator">=</span><span class="token-number">2</span><span class="token-plain"> loops</span><span class="token-operator">=</span><span class="token-number">1</span><span class="token-punctuation">)</span></div></div><div></div></code></pre></div></div><div style="overflow:auto;height:100%;width:100%"><div class="cs-container" style="width:100%;height:100%;max-height:100%;position:relative"><pre class="cs-content css-15hx6wk" style="margin:0;height:100%;overflow:hidden"><code class="cs-scaled-content css-7wj8j4" style="display:block;height:100%;transform:scale(1);transform-origin:center 0px"><div></div><div style="overflow:hidden;height:100px;opacity:1"><div style="display:inline-block" class="cs-line cs-line-4"><span class="token-plain">​</span></div></div><div style="overflow:hidden;height:100px;opacity:0.6"><div style="display:inline-block" class="cs-line cs-line-5"><span class="token-keyword">Index</span><span class="token-plain"> Scan </span><span class="token-keyword">using</span><span class="token-plain"> users_pkey </span><span class="token-keyword">on</span><span class="token-plain"> users </span><span class="token-punctuation">(</span><span class="token-plain">actual </span><span class="token-keyword">time</span><span class="token-operator">=</span><span class="token-number">0.036</span><span class="token-punctuation">.</span><span class="token-number">.0</span><span class="token-number">.041</span><span class="token-plain"> </span><span class="token-keyword">rows</span><span class="token-operator">=</span><span class="token-number">2</span><span class="token-plain"> loops</span><span class="token-operator">=</span><span class="token-number">1</span><span class="token-punctuation">)</span></div></div><div></div></code></pre></div></div></div></div><div style="position:absolute;font-size:30px;right:10px;bottom:10px"></div></div><div class="css-1qmwe25"><img src="/2023-09-16-dotnext-b-tree-indices-in-postgresql/static/btree-find84.drawio-bb3c22a586d5e2e93d63d2abcfe08fef.svg" width="100%" class="css-wnzno2"/><div style="position:absolute;font-size:30px;right:10px;bottom:10px"></div></div><div class="css-1qmwe25"><div style="text-align:left;font-size:60px" class="css-0"><ul class="css-1uk1gs8"><li class="css-0">База может сканировать диапазоны<br/> по возрастанию и убыванию</li></ul><ul class="css-1uk1gs8"><li style="visibility:visible" class="css-0">&quot;Заходим&quot; в индекс лишь один раз,<br/> далее следуем по списку</li><li style="visibility:visible" class="css-0">За данными по-прежнему ходим в таблицу</li></ul></div><div style="position:absolute;font-size:30px;right:10px;bottom:10px"></div></div><div class="css-1qmwe25"><div style="width:100vw;max-width:100%;height:100vh;display:flex;flex-direction:column;justify-content:center;align-items:center" class="cs-layout"><div style="overflow:auto;height:100%;width:100%"><div style="overflow:auto;height:100%;width:100%"><div class="cs-container" style="width:100%;height:100%;max-height:100%;position:relative"><pre class="cs-content css-15hx6wk" style="margin:0;height:100%;overflow:hidden"><code class="cs-scaled-content css-7wj8j4" style="display:block;height:100%;transform:scale(1);transform-origin:center 0px"><div></div><div style="overflow:hidden;height:100px;opacity:1"><div style="display:inline-block" class="cs-line cs-line-0"><span class="token-keyword">explain</span><span class="token-plain"> </span><span class="token-punctuation">(</span><span class="token-keyword">analyze</span><span class="token-punctuation">,</span><span class="token-plain"> costs </span><span class="token-keyword">off</span><span class="token-punctuation">,</span><span class="token-plain"> buffers</span><span class="token-punctuation">)</span></div></div><div style="overflow:hidden;height:100px;opacity:1"><div style="display:inline-block" class="cs-line cs-line-1"><span class="token-plain">  </span><span class="token-keyword">select</span><span class="token-plain"> id</span></div></div><div style="overflow:hidden;height:100px;opacity:1"><div style="display:inline-block" class="cs-line cs-line-2"><span class="token-plain">    </span><span class="token-keyword">from</span><span class="token-plain"> users</span></div></div><div style="overflow:hidden;height:100px;opacity:1"><div style="display:inline-block" class="cs-line cs-line-3"><span class="token-plain">    </span><span class="token-keyword">where</span><span class="token-plain"> id </span><span class="token-operator">&gt;=</span><span class="token-plain"> </span><span class="token-number">5</span><span class="token-plain"> </span><span class="token-operator">and</span><span class="token-plain"> id </span><span class="token-operator">&lt;=</span><span class="token-plain"> </span><span class="token-number">8</span><span class="token-punctuation">;</span></div></div><div style="overflow:hidden;height:0;opacity:0"><div style="display:inline-block" class="cs-line cs-line-4"><span class="token-plain">​</span></div></div><div style="overflow:hidden;height:0;opacity:0"><div style="display:inline-block" class="cs-line cs-line-5"><span class="token-keyword">Index</span><span class="token-plain"> Only Scan </span><span class="token-keyword">using</span><span class="token-plain"> users_pkey </span><span class="token-keyword">on</span><span class="token-plain"> users </span><span class="token-punctuation">(</span><span class="token-plain">actual </span><span class="token-keyword">time</span><span class="token-operator">=</span><span class="token-number">0.015</span><span class="token-punctuation">.</span><span class="token-number">.0</span><span class="token-number">.018</span><span class="token-plain"> </span><span class="token-keyword">rows</span><span class="token-operator">=</span><span class="token-number">4</span><span class="token-plain"> loops</span><span class="token-operator">=</span><span class="token-number">1</span><span class="token-punctuation">)</span></div></div><div></div></code></pre></div></div><div style="overflow:auto;height:100%;width:100%"><div class="cs-container" style="width:100%;height:100%;max-height:100%;position:relative"><pre class="cs-content css-15hx6wk" style="margin:0;height:100%;overflow:hidden"><code class="cs-scaled-content css-7wj8j4" style="display:block;height:100%;transform:scale(1);transform-origin:center 0px"><div></div><div style="overflow:hidden;opacity:1"><div style="display:inline-block" class="cs-line cs-line-4"><span class="token-plain">​</span></div></div><div style="overflow:hidden;opacity:0.6"><div style="display:inline-block" class="cs-line cs-line-5"><span class="token-keyword">Index</span><span class="token-plain"> Only Scan </span><span class="token-keyword">using</span><span class="token-plain"> users_pkey </span><span class="token-keyword">on</span><span class="token-plain"> users </span><span class="token-punctuation">(</span><span class="token-plain">actual </span><span class="token-keyword">time</span><span class="token-operator">=</span><span class="token-number">0.015</span><span class="token-punctuation">.</span><span class="token-number">.0</span><span class="token-number">.018</span><span class="token-plain"> </span><span class="token-keyword">rows</span><span class="token-operator">=</span><span class="token-number">4</span><span class="token-plain"> loops</span><span class="token-operator">=</span><span class="token-number">1</span><span class="token-punctuation">)</span></div></div><div></div></code></pre></div></div><div style="overflow:auto;height:100%;width:100%"><div class="cs-container" style="width:100%;height:100%;max-height:100%;position:relative"><pre class="cs-content css-15hx6wk" style="margin:0;height:100%;overflow:hidden"><code class="cs-scaled-content css-7wj8j4" style="display:block;height:100%;transform:scale(1);transform-origin:center 0px"><div></div><div style="overflow:hidden;opacity:0.6"><div style="display:inline-block" class="cs-line cs-line-4"><span class="token-plain">​</span></div></div><div style="overflow:hidden;opacity:0.6"><div style="display:inline-block" class="cs-line cs-line-5"><span class="token-keyword">Index</span><span class="token-plain"> Only Scan </span><span class="token-keyword">using</span><span class="token-plain"> users_pkey </span><span class="token-keyword">on</span><span class="token-plain"> users </span><span class="token-punctuation">(</span><span class="token-plain">actual </span><span class="token-keyword">time</span><span class="token-operator">=</span><span class="token-number">0.015</span><span class="token-punctuation">.</span><span class="token-number">.0</span><span class="token-number">.018</span><span class="token-plain"> </span><span class="token-keyword">rows</span><span class="token-operator">=</span><span class="token-number">4</span><span class="token-plain"> loops</span><span class="token-operator">=</span><span class="token-number">1</span><span class="token-punctuation">)</span></div></div><div></div></code></pre><h4 class="cs-title css-1bb7pgx" style="opacity:0"><span style="opacity:1"></span></h4></div></div><div style="overflow:auto;height:100%;width:100%"><div class="cs-container" style="width:100%;height:100%;max-height:100%;position:relative"><pre class="cs-content css-15hx6wk" style="margin:0;height:100%;overflow:hidden"><code class="cs-scaled-content css-7wj8j4" style="display:block;height:100%;transform:scale(1);transform-origin:center 0px"><div></div><div style="overflow:hidden;height:100px;opacity:0.6"><div style="display:inline-block" class="cs-line cs-line-4"><span class="token-plain">​</span></div></div><div style="overflow:hidden;height:100px;opacity:0.6"><div style="display:inline-block" class="cs-line cs-line-5"><span class="token-keyword">Index</span><span class="token-plain"> Only Scan </span><span class="token-keyword">using</span><span class="token-plain"> users_pkey </span><span class="token-keyword">on</span><span class="token-plain"> users </span><span class="token-punctuation">(</span><span class="token-plain">actual </span><span class="token-keyword">time</span><span class="token-operator">=</span><span class="token-number">0.015</span><span class="token-punctuation">.</span><span class="token-number">.0</span><span class="token-number">.018</span><span class="token-plain"> </span><span class="token-keyword">rows</span><span class="token-operator">=</span><span class="token-number">4</span><span class="token-plain"> loops</span><span class="token-operator">=</span><span class="token-number">1</span><span class="token-punctuation">)</span></div></div><div></div></code></pre><h4 class="cs-title css-1bb7pgx" style="opacity:1"><span style="opacity:1">индекс не хранит информацию о видимости строк</span></h4></div></div></div></div><div style="position:absolute;font-size:30px;right:10px;bottom:10px"></div></div><div class="css-1qmwe25"><h1 class="css-1oufjjy">Крутим дерево</h1><div style="position:absolute;font-size:30px;right:10px;bottom:10px"></div></div><div class="css-1qmwe25"><img src="/2023-09-16-dotnext-b-tree-indices-in-postgresql/static/btree-split_00.drawio-f13a1c9877b410aa6fb93005502b92d1.svg" class="css-wnzno2"/><div style="position:absolute;font-size:30px;right:10px;bottom:10px"></div></div><div class="css-1qmwe25"><img src="/2023-09-16-dotnext-b-tree-indices-in-postgresql/static/btree-split_00.drawio-f13a1c9877b410aa6fb93005502b92d1.svg" class="css-wnzno2"/><h2 style="position:absolute;bottom:2em" class="css-1djqpdg">Добавляем 7</h2><div style="position:absolute;font-size:30px;right:10px;bottom:10px"></div></div><div class="css-1qmwe25"><img src="/2023-09-16-dotnext-b-tree-indices-in-postgresql/static/btree-split_01.drawio-eb959e71c3e7f9e6a8f549758895f48f.svg" class="css-wnzno2"/><h2 style="position:absolute;bottom:2em" class="css-1djqpdg">Добавляем 7</h2><div style="position:absolute;font-size:30px;right:10px;bottom:10px"></div></div><div class="css-1qmwe25"><img src="/2023-09-16-dotnext-b-tree-indices-in-postgresql/static/btree-split_01x.drawio-64fb4e06f5e7fc6179ac1ee7068c8ebc.svg" class="css-wnzno2"/><h2 style="position:absolute;bottom:2em" class="css-1djqpdg">С корня НЕ начинаем</h2><div style="position:absolute;font-size:30px;right:10px;bottom:10px"></div></div><div class="css-1qmwe25"><img src="/2023-09-16-dotnext-b-tree-indices-in-postgresql/static/btree-split_00.drawio-f13a1c9877b410aa6fb93005502b92d1.svg" class="css-wnzno2"/><h2 style="position:absolute;bottom:2em" class="css-1djqpdg">Добавляем 7</h2><div style="position:absolute;font-size:30px;right:10px;bottom:10px"></div></div><div class="css-1qmwe25"><img src="/2023-09-16-dotnext-b-tree-indices-in-postgresql/static/btree-split_02.drawio-17f469d80ca9da32050eea0e8f6477b3.svg" class="css-wnzno2"/><h2 style="position:absolute;bottom:2em" class="css-1djqpdg">Сначала ищем куда попадает 7</h2><div style="position:absolute;font-size:30px;right:10px;bottom:10px"></div></div><div class="css-1qmwe25"><img src="/2023-09-16-dotnext-b-tree-indices-in-postgresql/static/btree-split_03.drawio-bccd97c84856ca7b1d203883689d13ac.svg" class="css-wnzno2"/><h2 style="position:absolute;bottom:2em" class="css-1djqpdg">Добавляем пустую страницу</h2><div style="position:absolute;font-size:30px;right:10px;bottom:10px"></div></div><div class="css-1qmwe25"><img src="/2023-09-16-dotnext-b-tree-indices-in-postgresql/static/btree-split_04.drawio-bf6bd598710683fcaa3c9c49322d01af.svg" class="css-wnzno2"/><h2 style="position:absolute;bottom:2em" class="css-1djqpdg">Переносим данные</h2><div style="position:absolute;font-size:30px;right:10px;bottom:10px"></div></div><div class="css-1qmwe25"><img src="/2023-09-16-dotnext-b-tree-indices-in-postgresql/static/btree-split_05.drawio-874439482a44a0fb20abc9f69ba925d6.svg" class="css-wnzno2"/><h2 style="position:absolute;bottom:2em" class="css-1djqpdg">Связываем с индексом</h2><div style="position:absolute;font-size:30px;right:10px;bottom:10px"></div></div><div class="css-1qmwe25"><img src="/2023-09-16-dotnext-b-tree-indices-in-postgresql/static/btree-split_06.drawio-3e57801712c7b7a5abba899f85b40471.svg" class="css-wnzno2"/><h2 style="position:absolute;bottom:2em" class="css-1djqpdg">Добавляем запись в родительскую страницу</h2><div style="position:absolute;font-size:30px;right:10px;bottom:10px"></div></div><div class="css-1qmwe25"><img src="/2023-09-16-dotnext-b-tree-indices-in-postgresql/static/btree-split_07.drawio-f1d21dbcea67620c023f77896ad6ed96.svg" class="css-wnzno2"/><div style="position:absolute;font-size:30px;right:10px;bottom:10px"></div></div><div class="css-1qmwe25"><img src="/2023-09-16-dotnext-b-tree-indices-in-postgresql/static/btree-split_07.drawio-f1d21dbcea67620c023f77896ad6ed96.svg" class="css-wnzno2"/><h2 style="position:absolute;bottom:2em" class="css-1djqpdg">На практике в странице <span style="color:rgb(102,255,122)">100+</span> записей</h2><div style="position:absolute;font-size:30px;right:10px;bottom:10px"></div></div><div class="css-1qmwe25"><img src="/2023-09-16-dotnext-b-tree-indices-in-postgresql/static/btree-split_07.drawio-f1d21dbcea67620c023f77896ad6ed96.svg" class="css-wnzno2"/><h2 style="position:absolute;bottom:2em" class="css-1djqpdg">На <span style="color:rgb(102,255,122)">1 млн</span> строк нужно всего <span style="color:rgb(102,255,122)">3 уровня</span></h2><div style="position:absolute;font-size:30px;right:10px;bottom:10px"></div></div><div class="css-1qmwe25"><h1 class="css-1oufjjy">UUID vs bigint</h1><div style="position:absolute;font-size:30px;right:10px;bottom:10px"></div></div><div class="css-1qmwe25"><div style="width:100vw;max-width:100%;height:100vh;display:flex;flex-direction:column;justify-content:center;align-items:center" class="cs-layout"><div style="overflow:auto;height:100%;width:100%"><div style="overflow:auto;height:100%;width:100%"><div class="cs-container" style="width:100%;height:100%;max-height:100%;position:relative"><pre class="cs-content css-15hx6wk" style="margin:0;height:100%;overflow:hidden"><code class="cs-scaled-content css-7wj8j4" style="display:block;height:100%;transform:scale(1);transform-origin:center 0px"><div></div><div style="overflow:hidden;height:100px;opacity:1"><div style="display:inline-block" class="cs-line cs-line-0"><span class="token-keyword">create</span><span class="token-plain"> </span><span class="token-keyword">table</span><span class="token-plain"> users </span><span class="token-punctuation">(</span></div></div><div style="overflow:hidden;height:100px;opacity:1"><div style="display:inline-block" class="cs-line cs-line-1"><span class="token-plain">  id </span><span class="token-keyword">bigint</span><span class="token-plain"> </span><span class="token-keyword">primary</span><span class="token-plain"> </span><span class="token-keyword">key</span><span class="token-punctuation">,</span></div></div><div style="overflow:hidden;height:100px;opacity:1"><div style="display:inline-block" class="cs-line cs-line-2"><span class="token-plain">  name </span><span class="token-keyword">varchar</span><span class="token-punctuation">(</span><span class="token-number">200</span><span class="token-punctuation">)</span></div></div><div style="overflow:hidden;height:100px;opacity:1"><div style="display:inline-block" class="cs-line cs-line-3"><span class="token-punctuation">)</span><span class="token-punctuation">;</span></div></div><div style="overflow:hidden;height:100px;opacity:1"><div style="display:inline-block" class="cs-line cs-line-4"><span class="token-plain">​</span></div></div><div style="overflow:hidden;height:100px;opacity:1"><div style="display:inline-block" class="cs-line cs-line-5"><span class="token-plain">vs</span></div></div><div style="overflow:hidden;height:100px;opacity:1"><div style="display:inline-block" class="cs-line cs-line-6"><span class="token-plain">​</span></div></div><div style="overflow:hidden;height:100px;opacity:1"><div style="display:inline-block" class="cs-line cs-line-7"><span class="token-keyword">create</span><span class="token-plain"> </span><span class="token-keyword">table</span><span class="token-plain"> users </span><span class="token-punctuation">(</span></div></div><div style="overflow:hidden;height:100px;opacity:1"><div style="display:inline-block" class="cs-line cs-line-8"><span class="token-plain">  id uuid </span><span class="token-keyword">primary</span><span class="token-plain"> </span><span class="token-keyword">key</span><span class="token-punctuation">,</span></div></div><div style="overflow:hidden;height:100px;opacity:1"><div style="display:inline-block" class="cs-line cs-line-9"><span class="token-plain">  name </span><span class="token-keyword">varchar</span><span class="token-punctuation">(</span><span class="token-number">200</span><span class="token-punctuation">)</span></div></div><div style="overflow:hidden;height:100px;opacity:1"><div style="display:inline-block" class="cs-line cs-line-10"><span class="token-punctuation">)</span><span class="token-punctuation">;</span></div></div><div></div></code></pre></div></div></div></div><div style="position:absolute;font-size:30px;right:10px;bottom:10px"></div></div><div class="css-1qmwe25"><div style="text-align:left;font-size:60px" class="css-0"><ul class="css-1uk1gs8"><li class="css-0">bigint <!-- -->—<!-- --> 8 байт</li></ul><ul class="css-1uk1gs8"><li style="visibility:visible" class="css-0">uuid <!-- -->—<!-- --> 16 байт</li><li style="visibility:visible" class="css-0">Значит индекс по uuid будет хуже, как же ещё?</li><li style="visibility:visible" class="css-0">Рассмотрим массовую вставку</li></ul></div><div style="position:absolute;font-size:30px;right:10px;bottom:10px"></div></div><div class="css-1qmwe25"><div style="width:100vw;max-width:100%;height:100vh;display:flex;flex-direction:column;justify-content:center;align-items:center" class="cs-layout"><div style="overflow:auto;height:100%;width:100%"><div style="overflow:auto;height:100%;width:100%"><div class="cs-container" style="width:100%;height:100%;max-height:100%;position:relative"><pre class="cs-content css-15hx6wk" style="margin:0;height:100%;overflow:hidden"><code class="cs-scaled-content css-7wj8j4" style="display:block;height:100%;transform:scale(1);transform-origin:center 0px"><div></div><div style="overflow:hidden;height:100px;opacity:1"><div style="display:inline-block" class="cs-line cs-line-0"><span class="token-keyword">insert</span><span class="token-plain"> </span><span class="token-keyword">into</span><span class="token-plain"> users</span><span class="token-punctuation">(</span><span class="token-plain">id_bigint</span><span class="token-punctuation">,</span><span class="token-plain"> name</span><span class="token-punctuation">)</span></div></div><div style="overflow:hidden;height:100px;opacity:1"><div style="display:inline-block" class="cs-line cs-line-1"><span class="token-plain">  </span><span class="token-keyword">select</span><span class="token-plain"> nextval</span><span class="token-punctuation">(</span><span class="token-string">&#x27;serial&#x27;</span><span class="token-punctuation">)</span><span class="token-punctuation">,</span><span class="token-plain"> </span><span class="token-string">&#x27;test&#x27;</span><span class="token-plain"> </span><span class="token-operator">||</span><span class="token-plain"> g</span><span class="token-punctuation">.</span><span class="token-plain">x</span></div></div><div style="overflow:hidden;opacity:1"><div style="display:inline-block" class="cs-line cs-line-2"><span class="token-plain">    </span><span class="token-keyword">from</span><span class="token-plain"> generate_series</span><span class="token-punctuation">(</span><span class="token-number">1</span><span class="token-punctuation">,</span><span class="token-plain"> </span><span class="token-number">1000</span><span class="token-punctuation">)</span><span class="token-plain"> </span><span class="token-keyword">as</span><span class="token-plain"> g</span><span class="token-punctuation">(</span><span class="token-plain">x</span><span class="token-punctuation">)</span><span class="token-punctuation">;</span></div></div><div style="overflow:hidden;height:0;opacity:0"><div style="display:inline-block" class="cs-line cs-line-3"><span class="token-plain">​</span></div></div><div></div></code></pre></div></div><div style="overflow:auto;height:100%;width:100%"><div class="cs-container" style="width:100%;height:100%;max-height:100%;position:relative"><pre class="cs-content css-15hx6wk" style="margin:0;height:100%;overflow:hidden"><code class="cs-scaled-content css-7wj8j4" style="display:block;height:100%;transform:scale(1);transform-origin:center 0px"><div></div><div style="overflow:hidden;height:100px;opacity:0.6"><div style="display:inline-block" class="cs-line cs-line-2"><span class="token-plain">    </span><span class="token-keyword">from</span><span class="token-plain"> generate_series</span><span class="token-punctuation">(</span><span class="token-number">1</span><span class="token-punctuation">,</span><span class="token-plain"> </span><span class="token-number">1000</span><span class="token-punctuation">)</span><span class="token-plain"> </span><span class="token-keyword">as</span><span class="token-plain"> g</span><span class="token-punctuation">(</span><span class="token-plain">x</span><span class="token-punctuation">)</span><span class="token-punctuation">;</span></div></div><div style="overflow:hidden;height:100px;opacity:1"><div style="display:inline-block" class="cs-line cs-line-3"><span class="token-plain">​</span></div></div><div></div></code></pre></div></div></div></div><div style="position:absolute;font-size:30px;right:10px;bottom:10px"></div></div><div class="css-1qmwe25"><img src="/2023-09-16-dotnext-b-tree-indices-in-postgresql/static/btree-таблица.drawio-132237a5ae0e4162ef3bb88cb98efa05.svg" width="100%" class="css-wnzno2"/><div style="position:absolute;font-size:30px;right:10px;bottom:10px"></div></div><div class="css-1qmwe25"><div style="margin:3em;text-align:left;font-size:60px" class="css-0"><ul class="css-1uk1gs8"><li class="css-0">Случайные UUID будут попадать в случайные места индекса</li></ul><ul class="css-1uk1gs8"><li style="visibility:visible" class="css-0">Это вызовет больше чтений с диска</li><li style="visibility:visible" class="css-0">А за счёт full_page_writes будет гораздо больше<br/> записей на диск<br/> <a href="https://www.2ndquadrant.com/en/blog/on-the-impact-of-full-page-writes/" class="css-2lflbl">https://www.2ndquadrant.com/en/blog/on-the-impact-of-full-page-writes/</a></li></ul></div><div style="position:absolute;font-size:30px;right:10px;bottom:10px"></div></div><div class="css-1qmwe25"><div style="text-align:left;font-size:60px" class="css-0"><h2 class="css-1djqpdg">Что делать с UUID&#x27;ами?</h2><ul class="css-1uk1gs8"><li style="visibility:visible" class="css-0">Использовать time-based UUID v7</li><li style="visibility:visible" class="css-0">Запасаться SSD</li></ul></div><div style="position:absolute;font-size:30px;right:10px;bottom:10px"></div></div><div class="css-1qmwe25"><h1 class="css-1oufjjy">Удаление данных</h1><div style="position:absolute;font-size:30px;right:10px;bottom:10px"></div></div><div class="css-1qmwe25"><img src="/2023-09-16-dotnext-b-tree-indices-in-postgresql/static/btree-index_table01_del8-04e2931ce979b16236a94c0bf7932d01.svg" width="100%" class="css-wnzno2"/><div style="position:absolute;font-size:30px;right:10px;bottom:10px"></div></div><div class="css-1qmwe25"><div style="margin:3em;text-align:left;font-size:60px" class="css-0"><h2 class="css-1djqpdg">Удаление из индекса</h2><ul class="css-1uk1gs8"><li style="visibility:visible" class="css-0">Индекс не хранит информацию о видимости строк</li><li style="visibility:visible" class="css-0">Поэтому удаление не требует обновления индекса</li><li style="visibility:visible" class="css-0">Но в индексе копится мусор (bloat)</li><li style="visibility:visible" class="css-0">Его собирает (auto-)vacuum</li></ul></div><div style="position:absolute;font-size:30px;right:10px;bottom:10px"></div></div><div class="css-1qmwe25"><div style="margin:3em;text-align:left;font-size:60px" class="css-0"><h2 class="css-1djqpdg">Удаление в PostgreSQL 14+</h2><ul class="css-1uk1gs8"><li style="visibility:visible" class="css-0">Выполняется в момент разделения блоков</li><li style="visibility:visible" class="css-0">&quot;Bottom-up&quot; deletion <br/> <a href="https://www.percona.com/blog/postgresql-14-b-tree-index-reduced-bloat-with-bottom-up-deletion/" class="css-2lflbl">https://www.percona.com/blog/postgresql-14-b-tree-index-reduced-bloat-with-bottom-up-deletion/</a></li></ul></div><div style="position:absolute;font-size:30px;right:10px;bottom:10px"></div></div><div class="css-1qmwe25"><h2 class="css-1djqpdg">Foreign keys</h2><div style="position:absolute;font-size:30px;right:10px;bottom:10px"></div></div><div class="css-1qmwe25"><div style="width:100vw;max-width:100%;height:100vh;display:flex;flex-direction:column;justify-content:center;align-items:center" class="cs-layout"><div style="overflow:auto;height:100%;width:100%"><div style="overflow:auto;height:100%;width:100%"><div class="cs-container" style="width:100%;height:100%;max-height:100%;position:relative"><pre class="cs-content css-15hx6wk" style="margin:0;height:100%;overflow:hidden"><code class="cs-scaled-content css-7wj8j4" style="display:block;height:100%;transform:scale(1);transform-origin:center 0px"><div></div><div style="overflow:hidden;height:100px;opacity:1"><div style="display:inline-block" class="cs-line cs-line-0"><span class="token-keyword">create</span><span class="token-plain"> </span><span class="token-keyword">table</span><span class="token-plain"> users </span><span class="token-punctuation">(</span></div></div><div style="overflow:hidden;height:100px;opacity:1"><div style="display:inline-block" class="cs-line cs-line-1"><span class="token-plain">  id </span><span class="token-keyword">bigint</span><span class="token-plain"> </span><span class="token-keyword">primary</span><span class="token-plain"> </span><span class="token-keyword">key</span><span class="token-punctuation">,</span></div></div><div style="overflow:hidden;height:100px;opacity:1"><div style="display:inline-block" class="cs-line cs-line-2"><span class="token-plain">  user_name </span><span class="token-keyword">varchar</span><span class="token-punctuation">(</span><span class="token-number">200</span><span class="token-punctuation">)</span><span class="token-punctuation">,</span></div></div><div style="overflow:hidden;height:100px;opacity:1"><div style="display:inline-block" class="cs-line cs-line-7"><span class="token-punctuation">)</span><span class="token-punctuation">;</span></div></div><div style="overflow:hidden;height:0;opacity:0"><div style="display:inline-block" class="cs-line cs-line-8"><span class="token-plain">​</span></div></div><div style="overflow:hidden;height:0;opacity:0"><div style="display:inline-block" class="cs-line cs-line-13"><span class="token-plain">  project_name </span><span class="token-keyword">varchar</span><span class="token-punctuation">(</span><span class="token-number">200</span><span class="token-punctuation">)</span><span class="token-punctuation">,</span></div></div><div></div></code></pre></div></div><div style="overflow:auto;height:100%;width:100%"><div class="cs-container" style="width:100%;height:100%;max-height:100%;position:relative"><pre class="cs-content css-15hx6wk" style="margin:0;height:100%;overflow:hidden"><code class="cs-scaled-content css-7wj8j4" style="display:block;height:100%;transform:scale(1);transform-origin:center 0px"><div></div><div style="overflow:hidden;height:0;opacity:0"><div style="display:inline-block" class="cs-line cs-line-4"><span class="token-plain">  </span><span class="token-keyword">constraint</span><span class="token-plain"> project_id__users_fk</span></div></div><div style="overflow:hidden;opacity:1"><div style="display:inline-block" class="cs-line cs-line-8"><span class="token-plain">​</span></div></div><div style="overflow:hidden;height:100px;opacity:0.6"><div style="display:inline-block" class="cs-line cs-line-13"><span class="token-plain">  project_name </span><span class="token-keyword">varchar</span><span class="token-punctuation">(</span><span class="token-number">200</span><span class="token-punctuation">)</span><span class="token-punctuation">,</span></div></div><div></div></code></pre></div></div><div style="overflow:auto;height:100%;width:100%"><div class="cs-container" style="width:100%;height:100%;max-height:100%;position:relative"><pre class="cs-content css-15hx6wk" style="margin:0;height:100%;overflow:hidden"><code class="cs-scaled-content css-7wj8j4" style="display:block;height:100%;transform:scale(1);transform-origin:center 0px"><div></div><div style="overflow:hidden;height:100px;opacity:0.6"><div style="display:inline-block" class="cs-line cs-line-4"><span class="token-plain">  </span><span class="token-keyword">constraint</span><span class="token-plain"> project_id__users_fk</span></div></div><div style="overflow:hidden;opacity:0.6"><div style="display:inline-block" class="cs-line cs-line-8"><span class="token-plain">​</span></div></div><div style="overflow:hidden;height:0;opacity:0"><div style="display:inline-block" class="cs-line cs-line-9"><span class="token-keyword">create</span><span class="token-plain"> </span><span class="token-keyword">index</span><span class="token-plain"> project_id__users_ix </span><span class="token-keyword">on</span><span class="token-plain"> users</span><span class="token-punctuation">(</span><span class="token-plain">project_id</span><span class="token-punctuation">)</span><span class="token-punctuation">;</span></div></div><div></div></code></pre></div></div><div style="overflow:auto;height:100%;width:100%"><div class="cs-container" style="width:100%;height:100%;max-height:100%;position:relative"><pre class="cs-content css-15hx6wk" style="margin:0;height:100%;overflow:hidden"><code class="cs-scaled-content css-7wj8j4" style="display:block;height:100%;transform:scale(1);transform-origin:center 0px"><div></div><div style="overflow:hidden;height:100px;opacity:0.6"><div style="display:inline-block" class="cs-line cs-line-8"><span class="token-plain">​</span></div></div><div style="overflow:hidden;height:100px;opacity:0.6"><div style="display:inline-block" class="cs-line cs-line-9"><span class="token-keyword">create</span><span class="token-plain"> </span><span class="token-keyword">index</span><span class="token-plain"> project_id__users_ix </span><span class="token-keyword">on</span><span class="token-plain"> users</span><span class="token-punctuation">(</span><span class="token-plain">project_id</span><span class="token-punctuation">)</span><span class="token-punctuation">;</span></div></div><div></div></code></pre></div></div></div></div><div style="position:absolute;font-size:30px;right:10px;bottom:10px"></div></div><div class="css-1qmwe25"><div style="margin:3em;text-align:left;font-size:40px" class="css-0"><h2 class="css-1djqpdg">Foreign keys</h2><ul class="css-1uk1gs8"><li style="visibility:visible" class="css-0">По умолчанию, индекс на <code class="css-6vhczm">foreign key</code> не создаётся</li><li style="visibility:visible" class="css-0">Без индекса удаление по FK будет блокировать таблицу    </li></ul></div><div style="position:absolute;font-size:30px;right:10px;bottom:10px"></div></div><div class="css-1qmwe25"><div style="margin:3em;text-align:left;font-size:60px" class="css-0"><h2 class="css-1djqpdg">Обновление индексированной колонки</h2><ul class="css-1uk1gs8"><li style="visibility:visible" class="css-0">Добавляется новая запись в индекс</li><li style="visibility:visible" class="css-0">Старая остаётся мёртвым грузом (bloat)</li><li style="visibility:visible" class="css-0">Новые версии добавляются во всех индексах, даже тех, которые логически не обновлялись</li></ul></div><div style="position:absolute;font-size:30px;right:10px;bottom:10px"></div></div><div class="css-1qmwe25"><div style="margin:3em;text-align:left;font-size:60px" class="css-0"><h2 class="css-1djqpdg">Обновление НЕиндексированной колонки</h2><ul class="css-1uk1gs8"><li style="visibility:visible" class="css-0">Если обновляем неиндексированную колонку, <br/> и строка остаётся на месте</li><li style="visibility:visible" class="css-0">Если строка не помещается, добавляется новая запись в индекс</li><li style="visibility:visible" class="css-0">Старая остаётся мёртвым грузом (bloat)</li></ul></div><div style="position:absolute;font-size:30px;right:10px;bottom:10px"></div></div><div class="css-1qmwe25"><h2 class="css-1djqpdg">Годы идут, backend растёт</h2><div style="position:absolute;font-size:30px;right:10px;bottom:10px"></div></div><div class="css-1qmwe25"><h2 class="css-1djqpdg">Многоколоночные индексы</h2><div style="position:absolute;font-size:30px;right:10px;bottom:10px"></div></div><div class="css-1qmwe25"><div style="width:100vw;max-width:100%;height:100vh;display:flex;flex-direction:column;justify-content:center;align-items:center" class="cs-layout"><div style="overflow:auto;height:100%;width:100%"><div style="overflow:auto;height:100%;width:100%"><div class="cs-container" style="width:100%;height:100%;max-height:100%;position:relative"><pre class="cs-content css-15hx6wk" style="margin:0;height:100%;overflow:hidden"><code class="cs-scaled-content css-7wj8j4" style="display:block;height:100%;transform:scale(1);transform-origin:center 0px"><div></div><div style="overflow:hidden;height:100px;opacity:1"><div style="display:inline-block" class="cs-line cs-line-0"><span class="token-keyword">create</span><span class="token-plain"> </span><span class="token-keyword">table</span><span class="token-plain"> users </span><span class="token-punctuation">(</span></div></div><div style="overflow:hidden;opacity:1"><div style="display:inline-block" class="cs-line cs-line-1"><span class="token-plain">  id </span><span class="token-keyword">bigint</span><span class="token-plain"> </span><span class="token-keyword">primary</span><span class="token-plain"> </span><span class="token-keyword">key</span><span class="token-punctuation">,</span></div></div><div style="overflow:hidden;height:100px;opacity:1"><div style="display:inline-block" class="cs-line cs-line-2"><span class="token-plain">  name </span><span class="token-keyword">varchar</span><span class="token-punctuation">(</span><span class="token-number">200</span><span class="token-punctuation">)</span><span class="token-punctuation">,</span></div></div><div style="overflow:hidden;height:100px;opacity:1"><div style="display:inline-block" class="cs-line cs-line-3"><span class="token-plain">  state varchar2</span><span class="token-punctuation">(</span><span class="token-number">20</span><span class="token-punctuation">)</span></div></div><div style="overflow:hidden;height:100px;opacity:1"><div style="display:inline-block" class="cs-line cs-line-7"><span class="token-punctuation">)</span><span class="token-punctuation">;</span></div></div><div style="overflow:hidden;height:0;opacity:0"><div style="display:inline-block" class="cs-line cs-line-8"><span class="token-plain">​</span></div></div><div></div></code></pre></div></div><div style="overflow:auto;height:100%;width:100%"><div class="cs-container" style="width:100%;height:100%;max-height:100%;position:relative"><pre class="cs-content css-15hx6wk" style="margin:0;height:100%;overflow:hidden"><code class="cs-scaled-content css-7wj8j4" style="display:block;height:100%;transform:scale(1);transform-origin:center 0px"><div></div><div style="overflow:hidden;opacity:0.6"><div style="display:inline-block" class="cs-line cs-line-1"><span class="token-plain">  id </span><span class="token-keyword">bigint</span><span class="token-plain"> </span><span class="token-keyword">primary</span><span class="token-plain"> </span><span class="token-keyword">key</span><span class="token-punctuation">,</span></div></div><div style="overflow:hidden;opacity:0.6"><div style="display:inline-block" class="cs-line cs-line-8"><span class="token-plain">​</span></div></div><div></div></code></pre></div></div><div style="overflow:auto;height:100%;width:100%"><div class="cs-container" style="width:100%;height:100%;max-height:100%;position:relative"><pre class="cs-content css-15hx6wk" style="margin:0;height:100%;overflow:hidden"><code class="cs-scaled-content css-7wj8j4" style="display:block;height:100%;transform:scale(1);transform-origin:center 0px"><div></div><div style="overflow:hidden;height:100px;opacity:0.6"><div style="display:inline-block" class="cs-line cs-line-1"><span class="token-plain">  id </span><span class="token-keyword">bigint</span><span class="token-plain"> </span><span class="token-keyword">primary</span><span class="token-plain"> </span><span class="token-keyword">key</span><span class="token-punctuation">,</span></div></div><div style="overflow:hidden"><div style="display:inline-block" class="cs-line cs-line-8"><span class="token-plain">​</span></div></div><div style="overflow:hidden;height:0;opacity:0"><div style="display:inline-block" class="cs-line cs-line-14"><span class="token-keyword">create</span><span class="token-plain"> </span><span class="token-keyword">index</span><span class="token-plain"> name_state__users </span><span class="token-keyword">on</span><span class="token-plain"> users</span><span class="token-punctuation">(</span><span class="token-plain">name</span><span class="token-punctuation">,</span><span class="token-plain"> state</span><span class="token-punctuation">)</span><span class="token-punctuation">;</span></div></div><div></div></code></pre></div></div><div style="overflow:auto;height:100%;width:100%"><div class="cs-container" style="width:100%;height:100%;max-height:100%;position:relative"><pre class="cs-content css-15hx6wk" style="margin:0;height:100%;overflow:hidden"><code class="cs-scaled-content css-7wj8j4" style="display:block;height:100%;transform:scale(1);transform-origin:center 0px"><div></div><div style="overflow:hidden"><div style="display:inline-block" class="cs-line cs-line-8"><span class="token-plain">​</span></div></div><div style="overflow:hidden;height:100px;opacity:0.6"><div style="display:inline-block" class="cs-line cs-line-14"><span class="token-keyword">create</span><span class="token-plain"> </span><span class="token-keyword">index</span><span class="token-plain"> name_state__users </span><span class="token-keyword">on</span><span class="token-plain"> users</span><span class="token-punctuation">(</span><span class="token-plain">name</span><span class="token-punctuation">,</span><span class="token-plain"> state</span><span class="token-punctuation">)</span><span class="token-punctuation">;</span></div></div><div style="overflow:hidden;height:0;opacity:0"><div style="display:inline-block" class="cs-line cs-line-16"><span class="token-keyword">create</span><span class="token-plain"> </span><span class="token-keyword">index</span><span class="token-plain"> state_name__users </span><span class="token-keyword">on</span><span class="token-plain"> users</span><span class="token-punctuation">(</span><span class="token-plain">state</span><span class="token-punctuation">,</span><span class="token-plain"> name</span><span class="token-punctuation">)</span><span class="token-plain"> </span><span class="token-keyword">where</span><span class="token-plain"> state </span><span class="token-operator">!=</span><span class="token-plain"> </span><span class="token-string">&#x27;ACTIVE&#x27;</span><span class="token-punctuation">;</span></div></div><div></div></code></pre></div></div><div style="overflow:auto;height:100%;width:100%"><div class="cs-container" style="width:100%;height:100%;max-height:100%;position:relative"><pre class="cs-content css-15hx6wk" style="margin:0;height:100%;overflow:hidden"><code class="cs-scaled-content css-7wj8j4" style="display:block;height:100%;transform:scale(1);transform-origin:center 0px"><div></div><div style="overflow:hidden"><div style="display:inline-block" class="cs-line cs-line-8"><span class="token-plain">​</span></div></div><div style="overflow:hidden;opacity:0.6"><div style="display:inline-block" class="cs-line cs-line-16"><span class="token-keyword">create</span><span class="token-plain"> </span><span class="token-keyword">index</span><span class="token-plain"> state_name__users </span><span class="token-keyword">on</span><span class="token-plain"> users</span><span class="token-punctuation">(</span><span class="token-plain">state</span><span class="token-punctuation">,</span><span class="token-plain"> name</span><span class="token-punctuation">)</span><span class="token-plain"> </span><span class="token-keyword">where</span><span class="token-plain"> state </span><span class="token-operator">!=</span><span class="token-plain"> </span><span class="token-string">&#x27;ACTIVE&#x27;</span><span class="token-punctuation">;</span></div></div><div></div></code></pre></div></div><div style="overflow:auto;height:100%;width:100%"><div class="cs-container" style="width:100%;height:100%;max-height:100%;position:relative"><pre class="cs-content css-15hx6wk" style="margin:0;height:100%;overflow:hidden"><code class="cs-scaled-content css-7wj8j4" style="display:block;height:100%;transform:scale(1);transform-origin:center 0px"><div></div><div style="overflow:hidden"><div style="display:inline-block" class="cs-line cs-line-8"><span class="token-plain">​</span></div></div><div style="overflow:hidden;opacity:0.6"><div style="display:inline-block" class="cs-line cs-line-16"><span class="token-keyword">create</span><span class="token-plain"> </span><span class="token-keyword">index</span><span class="token-plain"> state_name__users </span><span class="token-keyword">on</span><span class="token-plain"> users</span><span class="token-punctuation">(</span><span class="token-plain">state</span><span class="token-punctuation">,</span><span class="token-plain"> name</span><span class="token-punctuation">)</span><span class="token-plain"> </span><span class="token-keyword">where</span><span class="token-plain"> state </span><span class="token-operator">!=</span><span class="token-plain"> </span><span class="token-string">&#x27;ACTIVE&#x27;</span><span class="token-punctuation">;</span></div></div><div></div></code></pre></div></div><div style="overflow:auto;height:100%;width:100%"><div class="cs-container" style="width:100%;height:100%;max-height:100%;position:relative"><pre class="cs-content css-15hx6wk" style="margin:0;height:100%;overflow:hidden"><code class="cs-scaled-content css-7wj8j4" style="display:block;height:100%;transform:scale(1);transform-origin:center 0px"><div></div><div style="overflow:hidden;height:100px;opacity:1"><div style="display:inline-block" class="cs-line cs-line-8"><span class="token-plain">​</span></div></div><div style="overflow:hidden;height:100px;opacity:0.6"><div style="display:inline-block" class="cs-line cs-line-16"><span class="token-keyword">create</span><span class="token-plain"> </span><span class="token-keyword">index</span><span class="token-plain"> state_name__users </span><span class="token-keyword">on</span><span class="token-plain"> users</span><span class="token-punctuation">(</span><span class="token-plain">state</span><span class="token-punctuation">,</span><span class="token-plain"> name</span><span class="token-punctuation">)</span><span class="token-plain"> </span><span class="token-keyword">where</span><span class="token-plain"> state </span><span class="token-operator">!=</span><span class="token-plain"> </span><span class="token-string">&#x27;ACTIVE&#x27;</span><span class="token-punctuation">;</span></div></div><div></div></code></pre></div></div></div></div><div style="position:absolute;font-size:30px;right:10px;bottom:10px"></div></div><div class="css-1qmwe25"><div style="width:100vw;max-width:100%;height:100vh;display:flex;flex-direction:column;justify-content:center;align-items:center" class="cs-layout"><div style="overflow:auto;height:100%;width:100%"><div style="overflow:auto;height:100%;width:100%"><div class="cs-container" style="width:100%;height:100%;max-height:100%;position:relative"><pre class="cs-content css-15hx6wk" style="margin:0;height:100%;overflow:hidden"><code class="cs-scaled-content css-7wj8j4" style="display:block;height:100%;transform:scale(1);transform-origin:center 0px"><div></div><div style="overflow:hidden;opacity:1"><div style="display:inline-block" class="cs-line cs-line-0"><span class="token-keyword">create</span><span class="token-plain"> </span><span class="token-keyword">index</span><span class="token-plain"> </span><span class="token-punctuation">.</span><span class="token-punctuation">.</span><span class="token-punctuation">.</span><span class="token-plain"> </span><span class="token-keyword">on</span><span class="token-plain"> users</span><span class="token-punctuation">(</span><span class="token-plain">state</span><span class="token-punctuation">,</span><span class="token-plain"> name</span><span class="token-punctuation">)</span><span class="token-punctuation">;</span></div></div><div style="overflow:hidden;height:0;opacity:0"><div style="display:inline-block" class="cs-line cs-line-1"><span class="token-plain">​</span></div></div><div></div></code></pre></div></div><div style="overflow:auto;height:100%;width:100%"><div class="cs-container" style="width:100%;height:100%;max-height:100%;position:relative"><pre class="cs-content css-15hx6wk" style="margin:0;height:100%;overflow:hidden"><code class="cs-scaled-content css-7wj8j4" style="display:block;height:100%;transform:scale(1);transform-origin:center 0px"><div></div><div style="overflow:hidden;height:100px;opacity:0.6"><div style="display:inline-block" class="cs-line cs-line-0"><span class="token-keyword">create</span><span class="token-plain"> </span><span class="token-keyword">index</span><span class="token-plain"> </span><span class="token-punctuation">.</span><span class="token-punctuation">.</span><span class="token-punctuation">.</span><span class="token-plain"> </span><span class="token-keyword">on</span><span class="token-plain"> users</span><span class="token-punctuation">(</span><span class="token-plain">state</span><span class="token-punctuation">,</span><span class="token-plain"> name</span><span class="token-punctuation">)</span><span class="token-punctuation">;</span></div></div><div style="overflow:hidden;height:100px;opacity:1"><div style="display:inline-block" class="cs-line cs-line-1"><span class="token-plain">​</span></div></div><div></div></code></pre></div></div></div></div><div style="position:absolute;font-size:30px;right:10px;bottom:10px"></div></div><div class="css-1qmwe25"><style data-emotion-css="1j9hpr8">.css-1j9hpr8{width:100%;border-collapse:separate;border-spacing:0;}</style><table style="width:80%" class="css-1j9hpr8"><tr class="css-0"><style data-emotion-css="1eqt6ww">.css-1eqt6ww{text-align:left;padding-right:.5em;padding-top:.25em;padding-bottom:.25em;border-bottom:1px solid;vertical-align:top;}</style><th class="css-1eqt6ww">(state, name)</th><th class="css-1eqt6ww">(name, state)</th></tr><tr class="css-0"><td style="border:0px" class="css-1eqt6ww"><table style="width:20%;border:3px solid" class="css-1j9hpr8"><caption> </caption><tr class="css-0"><td class="css-1eqt6ww">ACTIVE</td><td class="css-1eqt6ww">test0</td></tr><tr class="css-0"><td class="css-1eqt6ww">ACTIVE</td><td class="css-1eqt6ww">test1</td></tr><tr class="css-0"><td class="css-1eqt6ww">ACTIVE</td><td class="css-1eqt6ww">test8</td></tr><tr class="css-0"><td class="css-1eqt6ww">ACTIVE</td><td class="css-1eqt6ww">test9</td></tr></table><table style="width:20%;border:3px solid" class="css-1j9hpr8"><caption> </caption><tr class="css-0"><td class="css-1eqt6ww">PENDING</td><td class="css-1eqt6ww">test2</td></tr><tr class="css-0"><td class="css-1eqt6ww">PENDING</td><td class="css-1eqt6ww">test4</td></tr><tr class="css-0"><td class="css-1eqt6ww">PENDING</td><td class="css-1eqt6ww">test5</td></tr><tr class="css-0"><td class="css-1eqt6ww">PENDING</td><td class="css-1eqt6ww">test7</td></tr></table></td><td style="border:0px" class="css-1eqt6ww"><table style="width:20%;border:3px solid" class="css-1j9hpr8"><caption> </caption><tr class="css-0"><td class="css-1eqt6ww">test0</td><td class="css-1eqt6ww">ACTIVE</td></tr><tr class="css-0"><td class="css-1eqt6ww">test1</td><td class="css-1eqt6ww">ACTIVE</td></tr><tr class="css-0"><td class="css-1eqt6ww">test2</td><td class="css-1eqt6ww">PENDING</td></tr><tr class="css-0"><td class="css-1eqt6ww">test4</td><td class="css-1eqt6ww">PENDING</td></tr></table><table style="width:20%;border:3px solid" class="css-1j9hpr8"><caption> </caption><tr class="css-0"><td class="css-1eqt6ww">test5</td><td class="css-1eqt6ww">PENDING</td></tr><tr class="css-0"><td class="css-1eqt6ww">test7</td><td class="css-1eqt6ww">PENDING</td></tr><tr class="css-0"><td class="css-1eqt6ww">test8</td><td class="css-1eqt6ww">ACTIVE</td></tr><tr class="css-0"><td class="css-1eqt6ww">test9</td><td class="css-1eqt6ww">ACTIVE</td></tr></table></td></tr></table><div style="position:absolute;font-size:30px;right:10px;bottom:10px"></div></div><div class="css-1qmwe25"><div style="width:100vw;max-width:100%;height:100vh;display:flex;flex-direction:column;justify-content:center;align-items:center" class="cs-layout"><div style="overflow:auto;height:100%;width:100%"><div style="overflow:auto;height:100%;width:100%"><div class="cs-container" style="width:100%;height:100%;max-height:100%;position:relative"><pre class="cs-content css-15hx6wk" style="margin:0;height:100%;overflow:hidden"><code class="cs-scaled-content css-7wj8j4" style="display:block;height:100%;transform:scale(1);transform-origin:center 0px"><div></div><div style="overflow:hidden;height:100px;opacity:1"><div style="display:inline-block" class="cs-line cs-line-0"><span class="token-keyword">select</span><span class="token-plain"> id</span><span class="token-punctuation">,</span><span class="token-plain"> name</span></div></div><div style="overflow:hidden;height:100px;opacity:1"><div style="display:inline-block" class="cs-line cs-line-1"><span class="token-plain">  </span><span class="token-keyword">from</span><span class="token-plain"> users</span></div></div><div style="overflow:hidden;height:100px;opacity:1"><div style="display:inline-block" class="cs-line cs-line-2"><span class="token-plain"> </span><span class="token-keyword">where</span><span class="token-plain"> name </span><span class="token-operator">=</span><span class="token-plain"> ?</span></div></div><div style="overflow:hidden;height:0;opacity:0"><div style="display:inline-block" class="cs-line cs-line-4"><span class="token-plain">​</span></div></div><div style="overflow:hidden;height:0;opacity:0"><div style="display:inline-block" class="cs-line cs-line-5"><span class="token-keyword">create</span><span class="token-plain"> </span><span class="token-keyword">index</span><span class="token-plain"> </span><span class="token-keyword">on</span><span class="token-plain"> users</span><span class="token-punctuation">(</span><span class="token-plain">state</span><span class="token-punctuation">,</span><span class="token-plain"> name</span><span class="token-punctuation">)</span><span class="token-punctuation">;</span></div></div><div></div></code></pre></div></div><div style="overflow:auto;height:100%;width:100%"><div class="cs-container" style="width:100%;height:100%;max-height:100%;position:relative"><pre class="cs-content css-15hx6wk" style="margin:0;height:100%;overflow:hidden"><code class="cs-scaled-content css-7wj8j4" style="display:block;height:100%;transform:scale(1);transform-origin:center 0px"><div></div><div style="overflow:hidden;height:0;opacity:0"><div style="display:inline-block" class="cs-line cs-line-3"><span class="token-plain">   </span><span class="token-operator">and</span><span class="token-plain"> state </span><span class="token-operator">in</span><span class="token-plain"> </span><span class="token-punctuation">(</span><span class="token-string">&#x27;ACTIVE&#x27;</span><span class="token-punctuation">,</span><span class="token-plain"> </span><span class="token-string">&#x27;INACTIVE&#x27;</span><span class="token-punctuation">)</span></div></div><div style="overflow:hidden;opacity:1"><div style="display:inline-block" class="cs-line cs-line-4"><span class="token-plain">​</span></div></div><div style="overflow:hidden;height:100px;opacity:0.6"><div style="display:inline-block" class="cs-line cs-line-5"><span class="token-keyword">create</span><span class="token-plain"> </span><span class="token-keyword">index</span><span class="token-plain"> </span><span class="token-keyword">on</span><span class="token-plain"> users</span><span class="token-punctuation">(</span><span class="token-plain">state</span><span class="token-punctuation">,</span><span class="token-plain"> name</span><span class="token-punctuation">)</span><span class="token-punctuation">;</span></div></div><div></div></code></pre></div></div><div style="overflow:auto;height:100%;width:100%"><div class="cs-container" style="width:100%;height:100%;max-height:100%;position:relative"><pre class="cs-content css-15hx6wk" style="margin:0;height:100%;overflow:hidden"><code class="cs-scaled-content css-7wj8j4" style="display:block;height:100%;transform:scale(1);transform-origin:center 0px"><div></div><div style="overflow:hidden;height:100px;opacity:0.6"><div style="display:inline-block" class="cs-line cs-line-3"><span class="token-plain">   </span><span class="token-operator">and</span><span class="token-plain"> state </span><span class="token-operator">in</span><span class="token-plain"> </span><span class="token-punctuation">(</span><span class="token-string">&#x27;ACTIVE&#x27;</span><span class="token-punctuation">,</span><span class="token-plain"> </span><span class="token-string">&#x27;INACTIVE&#x27;</span><span class="token-punctuation">)</span></div></div><div style="overflow:hidden;opacity:0.6"><div style="display:inline-block" class="cs-line cs-line-4"><span class="token-plain">​</span></div></div><div style="overflow:hidden;height:0;opacity:0"><div style="display:inline-block" class="cs-line cs-line-5"><span class="token-keyword">create</span><span class="token-plain"> </span><span class="token-keyword">index</span><span class="token-plain"> </span><span class="token-keyword">on</span><span class="token-plain"> users</span><span class="token-punctuation">(</span><span class="token-plain">state</span><span class="token-punctuation">,</span><span class="token-plain"> name</span><span class="token-punctuation">)</span><span class="token-punctuation">;</span></div></div><div></div></code></pre></div></div><div style="overflow:auto;height:100%;width:100%"><div class="cs-container" style="width:100%;height:100%;max-height:100%;position:relative"><pre class="cs-content css-15hx6wk" style="margin:0;height:100%;overflow:hidden"><code class="cs-scaled-content css-7wj8j4" style="display:block;height:100%;transform:scale(1);transform-origin:center 0px"><div></div><div style="overflow:hidden"><div style="display:inline-block" class="cs-line cs-line-4"><span class="token-plain">​</span></div></div><div style="overflow:hidden;opacity:0.6"><div style="display:inline-block" class="cs-line cs-line-5"><span class="token-keyword">create</span><span class="token-plain"> </span><span class="token-keyword">index</span><span class="token-plain"> </span><span class="token-keyword">on</span><span class="token-plain"> users</span><span class="token-punctuation">(</span><span class="token-plain">state</span><span class="token-punctuation">,</span><span class="token-plain"> name</span><span class="token-punctuation">)</span><span class="token-punctuation">;</span></div></div><div></div></code></pre></div></div><div style="overflow:auto;height:100%;width:100%"><div class="cs-container" style="width:100%;height:100%;max-height:100%;position:relative"><pre class="cs-content css-15hx6wk" style="margin:0;height:100%;overflow:hidden"><code class="cs-scaled-content css-7wj8j4" style="display:block;height:100%;transform:scale(1);transform-origin:center 0px"><div></div><div style="overflow:hidden"><div style="display:inline-block" class="cs-line cs-line-4"><span class="token-plain">​</span></div></div><div style="overflow:hidden;opacity:0.6"><div style="display:inline-block" class="cs-line cs-line-5"><span class="token-keyword">create</span><span class="token-plain"> </span><span class="token-keyword">index</span><span class="token-plain"> </span><span class="token-keyword">on</span><span class="token-plain"> users</span><span class="token-punctuation">(</span><span class="token-plain">state</span><span class="token-punctuation">,</span><span class="token-plain"> name</span><span class="token-punctuation">)</span><span class="token-punctuation">;</span></div></div><div></div></code></pre></div></div><div style="overflow:auto;height:100%;width:100%"><div class="cs-container" style="width:100%;height:100%;max-height:100%;position:relative"><pre class="cs-content css-15hx6wk" style="margin:0;height:100%;overflow:hidden"><code class="cs-scaled-content css-7wj8j4" style="display:block;height:100%;transform:scale(1);transform-origin:center 0px"><div></div><div style="overflow:hidden"><div style="display:inline-block" class="cs-line cs-line-4"><span class="token-plain">​</span></div></div><div style="overflow:hidden;opacity:0.6"><div style="display:inline-block" class="cs-line cs-line-5"><span class="token-keyword">create</span><span class="token-plain"> </span><span class="token-keyword">index</span><span class="token-plain"> </span><span class="token-keyword">on</span><span class="token-plain"> users</span><span class="token-punctuation">(</span><span class="token-plain">state</span><span class="token-punctuation">,</span><span class="token-plain"> name</span><span class="token-punctuation">)</span><span class="token-punctuation">;</span></div></div><div></div></code></pre></div></div><div style="overflow:auto;height:100%;width:100%"><div class="cs-container" style="width:100%;height:100%;max-height:100%;position:relative"><pre class="cs-content css-15hx6wk" style="margin:0;height:100%;overflow:hidden"><code class="cs-scaled-content css-7wj8j4" style="display:block;height:100%;transform:scale(1);transform-origin:center 0px"><div></div><div style="overflow:hidden"><div style="display:inline-block" class="cs-line cs-line-4"><span class="token-plain">​</span></div></div><div style="overflow:hidden;height:100px;opacity:0.6"><div style="display:inline-block" class="cs-line cs-line-5"><span class="token-keyword">create</span><span class="token-plain"> </span><span class="token-keyword">index</span><span class="token-plain"> </span><span class="token-keyword">on</span><span class="token-plain"> users</span><span class="token-punctuation">(</span><span class="token-plain">state</span><span class="token-punctuation">,</span><span class="token-plain"> name</span><span class="token-punctuation">)</span><span class="token-punctuation">;</span></div></div><div style="overflow:hidden;height:0;opacity:0"><div style="display:inline-block" class="cs-line cs-line-24"><span class="token-plain">  </span><span class="token-keyword">select</span><span class="token-plain"> </span><span class="token-punctuation">(</span><span class="token-keyword">select</span><span class="token-plain"> </span><span class="token-function">min</span><span class="token-punctuation">(</span><span class="token-plain">state</span><span class="token-punctuation">)</span><span class="token-plain"> </span><span class="token-keyword">from</span><span class="token-plain"> users </span><span class="token-keyword">where</span><span class="token-plain"> state</span><span class="token-operator">&gt;</span><span class="token-plain">t</span><span class="token-punctuation">.</span><span class="token-plain">state</span><span class="token-punctuation">)</span></div></div><div></div></code></pre></div></div><div style="overflow:auto;height:100%;width:100%"><div class="cs-container" style="width:100%;height:100%;max-height:100%;position:relative"><pre class="cs-content css-15hx6wk" style="margin:0;height:100%;overflow:hidden"><code class="cs-scaled-content css-7wj8j4" style="display:block;height:100%;transform:scale(1);transform-origin:center 0px"><div></div><div style="overflow:hidden;height:100px;opacity:1"><div style="display:inline-block" class="cs-line cs-line-4"><span class="token-plain">​</span></div></div><div style="overflow:hidden;height:100px;opacity:0.6"><div style="display:inline-block" class="cs-line cs-line-24"><span class="token-plain">  </span><span class="token-keyword">select</span><span class="token-plain"> </span><span class="token-punctuation">(</span><span class="token-keyword">select</span><span class="token-plain"> </span><span class="token-function">min</span><span class="token-punctuation">(</span><span class="token-plain">state</span><span class="token-punctuation">)</span><span class="token-plain"> </span><span class="token-keyword">from</span><span class="token-plain"> users </span><span class="token-keyword">where</span><span class="token-plain"> state</span><span class="token-operator">&gt;</span><span class="token-plain">t</span><span class="token-punctuation">.</span><span class="token-plain">state</span><span class="token-punctuation">)</span></div></div><div></div></code></pre></div></div></div></div><div style="position:absolute;font-size:30px;right:10px;bottom:10px"></div></div><div class="css-1qmwe25"><h2 class="css-1djqpdg">Из индекса по (state, name) можно выбирать уникальные значения <code class="css-6vhczm">state</code></h2><p class="css-0"><a href="https://wiki.postgresql.org/wiki/Loose_indexscan" class="css-2lflbl">https://wiki.postgresql.org/wiki/Loose_indexscan</a></p><div style="position:absolute;font-size:30px;right:10px;bottom:10px"></div></div><div class="css-1qmwe25"><h2 class="css-1djqpdg">Выводы</h2><div style="text-align:left;font-size:60px" class="css-0"><ul class="css-1uk1gs8"><li class="css-0">Дружите с вашими <span style="color:rgb(102,255,122)">индексами</span></li></ul><ul class="css-1uk1gs8"><li style="visibility:visible" class="css-0">Учитывайте <span style="color:rgb(102,255,122)">цель</span> оптимизации</li><li style="visibility:visible" class="css-0">Иногда имеющихся индексов <span style="color:rgb(102,255,122)">достаточно</span></li></ul></div><br/><br/><br/><br/><br/><div style="position:absolute;font-size:30px;right:10px;bottom:10px"></div></div><div class="css-1qmwe25"><p class="css-0">Владимир Ситников</p><p class="css-0"><a href="https://twitter.com/VladimirSitnikv" class="css-2lflbl">@VladimirSitnikv</a></p><a href="mailto:sitnikov.vladimir@gmail.com" class="css-2lflbl">sitnikov.vladimir@gmail.com</a><div style="position:absolute;font-size:30px;right:10px;bottom:10px"></div></div></div></div></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/print";window.webpackCompilationHash="e3b3d1247a2a68a34714";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app-78bd9bdba74bae70269f.js"],"component---gatsby-theme-mdx-deck-src-templates-deck-js":["/component---gatsby-theme-mdx-deck-src-templates-deck-js-83081728262a35733deb.js"]};/*]]>*/</script><script src="/2023-09-16-dotnext-b-tree-indices-in-postgresql/component---gatsby-theme-mdx-deck-src-templates-deck-js-83081728262a35733deb.js" async=""></script><script src="/2023-09-16-dotnext-b-tree-indices-in-postgresql/app-78bd9bdba74bae70269f.js" async=""></script><script src="/2023-09-16-dotnext-b-tree-indices-in-postgresql/commons-fd685cc757fe6153f6ab.js" async=""></script><script src="/2023-09-16-dotnext-b-tree-indices-in-postgresql/webpack-runtime-b838201ac9a3bfd7e165.js" async=""></script></body></html>